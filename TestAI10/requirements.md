# 蠕虫逃脱游戏需求文档

## 1. 项目概述

### 1.1 项目名称
蠕虫逃脱（Worm Escape）微信小游戏

### 1.2 项目类型
原生微信小游戏

### 1.3 游戏简介
玩家需要通过点击蠕虫身体来控制蠕虫移动，让所有蠕虫成功逃离矩阵。蠕虫只能向前移动，如果撞到其他蠕虫身体会归位，每关有三次失败机会。

## 2. 核心游戏机制

### 2.1 蠕虫移动规则
- **移动触发**：点击蠕虫身体的任意部位
- **移动方向**：蠕虫只能沿着头部方向向前移动
- **移动方式**：蠕虫沿逃脱路径逐步移动，一格一格前进

### 2.2 逃脱判定
- **可逃脱**：点击蠕虫后，如果存在从当前位置到矩阵边界的无障碍路径
  - 蠕虫自动沿着最短路径移动
  - 移动过程中播放移动动画
  - 到达矩阵边界后，蠕虫消失并播放逃脱特效
- **不可逃脱**：点击蠕虫后，如果移动会撞到其他蠕虫的身体部位
  - 蠕虫执行一次移动尝试
  - 检测到碰撞后，蠕虫高亮警示（红色闪烁）
  - 警示后，蠕虫后退复位到原始位置
  - 消耗一次失败机会

### 2.3 碰撞检测
- **碰撞对象**：其他蠕虫的身体部位（不包括头部）
- **碰撞判定**：蠕虫头部移动后的位置与其他蠕虫身体重叠
- **碰撞结果**：高亮警示 → 后退复位 → 失败次数+1

### 2.4 失败机制
- 每关初始有3次失败机会（显示为3个红心）
- 每次碰撞消耗1次失败机会
- 失败次数归零时，游戏失败，显示失败动画

### 2.5 胜利条件
- 所有蠕虫成功逃离矩阵
- 显示胜利动画和粒子特效

## 3. 关卡配置系统

### 3.1 配置文件格式
使用JSON格式存储关卡配置

### 3.2 配置数据结构
```json
{
  "levelId": 1,
  "matrix": {
    "width": 10,
    "height": 10
  },
  "escapePoints": [
    {"x": 0, "y": 5},
    {"x": 9, "y": 5}
  ],
  "worms": [
    {
      "id": 1,
      "segments": [
        {"x": 2, "y": 2},
        {"x": 3, "y": 2},
        {"x": 4, "y": 2}
      ],
      "direction": "right",
      "color": "#FF5733"
    }
  ]
}
```

### 3.3 配置项说明
- **levelId**: 关卡编号
- **matrix**: 矩阵大小（width × height）
- **escapePoints**: 逃脱点位置数组（矩阵边界坐标）
- **worms**: 蠕虫数组
  - **id**: 蠕虫唯一标识
  - **segments**: 蠕虫身体段坐标数组（第一个为头部，最后一个为尾部）
  - **direction**: 蠕虫朝向（up/down/left/right）
  - **color**: 蠕虫颜色（十六进制）

## 4. 功能需求

### 4.1 关卡选择界面
- 关卡列表展示（网格布局）
- 关卡状态显示（未解锁/已解锁/已完成）
- 关卡难度标识（可选）
- 点击关卡进入游戏

### 4.2 游戏主界面
- 顶部UI栏：
  - 关卡名称（如"关卡2"）
  - 失败次数显示（红心图标，3个）
  - 设置按钮
- 游戏区域：
  - 矩阵网格显示
  - 蠕虫渲染（带眼睛的头部、身体段）
  - 逃脱点标记
- 底部UI栏：
  - 缩放控制滑块（放大/缩小）

### 4.3 进度保存
- 本地存储关卡解锁状态
- 本地存储关卡完成状态
- 本地存储当前关卡进度（可选：支持中途退出后继续）

### 4.4 音效系统
- 背景音乐（循环播放）
- 点击音效
- 移动音效
- 碰撞警示音效
- 逃脱成功音效
- 胜利音效
- 失败音效
- 音效开关控制

### 4.5 特效系统
- **粒子特效**：
  - 蠕虫逃脱时的粒子爆炸效果
  - 胜利时的庆祝粒子效果
- **动画效果**：
  - 蠕虫移动动画（平滑过渡）
  - 碰撞高亮警示动画（红色闪烁）
  - 后退复位动画
  - 胜利动画（全屏庆祝效果）
  - 失败动画（全屏提示效果）

## 5. 技术需求

### 5.1 开发环境
- 微信小游戏基础库（最新稳定版本）
- 微信开发者工具

### 5.2 屏幕适配
- 支持不同屏幕尺寸（iPhone、Android各种尺寸）
- 响应式布局设计
- 保持游戏区域宽高比
- 适配横屏/竖屏（根据游戏设计决定）

### 5.3 性能要求
- 帧率稳定在60fps
- 加载时间优化
- 内存占用控制

### 5.4 代码结构建议
```
project/
├── game.js                 # 游戏主逻辑
├── game.json              # 游戏配置
├── config/
│   └── levels/            # 关卡配置文件夹
│       ├── level1.json
│       ├── level2.json
│       └── ...
├── scenes/
│   ├── MenuScene.js       # 关卡选择场景
│   ├── GameScene.js       # 游戏主场景
│   └── ResultScene.js     # 结果展示场景
├── managers/
│   ├── LevelManager.js    # 关卡管理器
│   ├── AudioManager.js    # 音频管理器
│   ├── StorageManager.js  # 存储管理器
│   └── EffectManager.js   # 特效管理器
├── entities/
│   └── Worm.js            # 蠕虫实体类
└── utils/
    ├── PathFinder.js      # 路径查找算法
    └── CollisionDetector.js # 碰撞检测
```

## 6. UI/UX需求

### 6.1 视觉设计
- 现代化、简洁的UI风格
- 蠕虫设计：圆润的身体段，头部带眼睛
- 清晰的网格线（可选）
- 逃脱点视觉标记

### 6.2 交互反馈
- 点击蠕虫时的视觉反馈（轻微放大/高亮）
- 移动过程中的平滑动画
- 碰撞时的明显警示效果
- 操作响应及时

### 6.3 引导系统（可选）
- 首次进入游戏的新手引导
- 关键操作提示

## 7. 路径查找算法

### 7.1 逃脱路径计算
- 使用A*算法或BFS算法查找最短路径
- 考虑其他蠕虫的当前位置
- 动态更新路径（其他蠕虫移动后重新计算）

### 7.2 碰撞预测
- 在移动前预测是否会碰撞
- 如果预测到碰撞，不执行移动，直接触发警示

## 8. 开发优先级

### Phase 1: 核心功能
1. 游戏主逻辑实现
2. 蠕虫移动和碰撞检测
3. 基础关卡配置系统
4. 简单UI界面

### Phase 2: 完善功能
1. 关卡选择界面
2. 进度保存
3. 音效系统
4. 基础动画

### Phase 3: 优化和特效
1. 粒子特效
2. 胜利/失败动画
3. 屏幕适配优化
4. 性能优化

## 9. 测试要点

- 碰撞检测准确性
- 路径查找正确性
- 不同屏幕尺寸适配
- 音效播放正常
- 进度保存和读取
- 关卡配置加载正确性

## 10. 详细交互流程

### 10.1 点击蠕虫处理流程
1. 用户点击蠕虫身体任意部位
2. 系统检测该蠕虫是否可以逃脱（路径查找）
3. **如果可逃脱**：
   - 计算最短逃脱路径
   - 播放点击音效
   - 蠕虫开始沿路径移动（一格一格）
   - 每移动一格播放移动音效和动画
   - 到达边界后播放逃脱特效和音效
   - 蠕虫消失
   - 检查是否所有蠕虫都已逃脱（胜利判定）
4. **如果不可逃脱**：
   - 蠕虫执行一次向前移动
   - 检测碰撞
   - 如果碰撞：
     - 播放碰撞警示音效
     - 蠕虫高亮警示（红色闪烁动画）
     - 蠕虫后退复位到原始位置
     - 失败次数-1
     - 更新UI显示（红心减少）
     - 如果失败次数为0，显示失败动画

### 10.2 路径查找详细说明
- 使用BFS（广度优先搜索）或A*算法
- 起点：蠕虫头部当前位置
- 终点：矩阵边界（逃脱点）
- 障碍物：其他蠕虫的身体段（不包括头部）
- 如果找到路径，返回路径数组；否则返回null

### 10.3 碰撞检测详细说明
- 获取蠕虫头部移动后的新位置
- 遍历所有其他蠕虫的身体段（不包括头部）
- 检查新位置是否与任何身体段重叠
- 如果重叠，判定为碰撞

## 11. 数据存储结构

### 11.1 本地存储数据结构
```javascript
{
  "unlockedLevels": [1, 2, 3],  // 已解锁关卡列表
  "completedLevels": [1, 2],   // 已完成关卡列表
  "currentLevel": 3,            // 当前关卡
  "settings": {
    "musicEnabled": true,       // 背景音乐开关
    "soundEnabled": true        // 音效开关
  }
}
```

### 11.2 存储API
- 使用微信小游戏的本地存储API（wx.setStorageSync / wx.getStorageSync）
- 数据持久化到本地

## 12. 性能优化建议

### 12.1 渲染优化
- 使用对象池管理蠕虫对象
- 只渲染可见区域的元素
- 使用Canvas离屏渲染优化

### 12.2 算法优化
- 路径查找结果缓存（如果其他蠕虫未移动）
- 碰撞检测使用空间分割优化
- 避免不必要的重计算

### 12.3 资源优化
- 图片资源压缩
- 音频资源压缩
- 按需加载关卡配置

## 13. 异常处理

### 13.1 关卡配置异常
- 配置文件格式错误处理
- 缺失必要字段处理
- 坐标越界处理

### 13.2 游戏逻辑异常
- 路径查找失败处理
- 碰撞检测异常处理
- 存储读写失败处理

## 14. 扩展功能（可选）

### 14.1 游戏功能扩展
- 撤销/重做功能
- 提示功能（显示可移动的蠕虫）
- 关卡编辑器
- 排行榜系统
- 分享功能

### 14.2 社交功能
- 分享到微信群
- 好友排行榜
- 成就系统

