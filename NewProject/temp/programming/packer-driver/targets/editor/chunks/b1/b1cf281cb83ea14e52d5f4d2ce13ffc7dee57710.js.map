{"version":3,"sources":["file:///G:/escapeworm/NewProject/assets/scripts/GameController.ts"],"names":["_decorator","Component","Node","director","Vec2","Vec3","UITransform","Graphics","Color","Label","Sprite","SpriteFrame","resources","Input","Worm","PathFinder","CollisionDetector","LevelManager","StorageManager","AudioManager","EffectManager","Logger","ccclass","property","GameController","levelManager","storageManager","audioManager","effectManager","worms","wormNodes","matrix","escapePoints","failCount","isGameOver","isVictory","currentLevelId","isWormsAppearing","isInitialized","offsetX","offsetY","graphics","zoomScale","isDragging","dragStartPos","dragStartOffset","mapOffsetX","mapOffsetY","wormHeadSprite","wormBodySprite","wormTailSprite","gameAreaSetup","onLoad","addComponent","init","getSettings","loadWormImages","setupGameArea","gameArea","uiTransform","getComponent","width","height","parentTransform","parent","log","on","EventType","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","TOUCH_CANCEL","onTouchCancel","loadSpriteFrame","e","warn","path","Promise","resolve","reject","load","err","spriteFrame","initLevel","levelId","forEach","n","destroy","updateUI","levelData","loadLevel","map","p","x","y","calculateRenderParams","wormConfig","wormNode","id","worm","setVisibleSegmentCount","push","getHeadPosition","direction","segments","length","drawGrid","animateWormsAppearance","error","transform","areaWidth","areaHeight","baseCellSizeX","baseCellSizeY","baseCellSize","Math","min","cellSize","gridWidth","gridHeight","centerOffsetX","centerOffsetY","setZoomScale","scale","max","limitDragRange","updateWormVisuals","resetMapPosition","getZoomScale","clear","strokeColor","lineWidth","screenX","moveTo","lineTo","screenY","stroke","worldToScreen","screenToWorld","floor","isValidEscapePosition","pos","matrixWidth","matrixHeight","maxDistance","isOutOfBounds","isInBounds","xInRange","yInRange","segmentInterval","Array","isArray","maxSegments","segmentIndex","wait","update","dt","i","hasEscaped","active","getInterpolatedSegments","visibleCount","visibleSegmentCount","renderWormSegments","logRenderState","head","screenPos","toFixed","isAnimating","debugWormState","isEscaped","isEscaping","currentCount","children","idx","segmentNode","isVisible","segment","setPosition","halfWidth","halfHeight","abs","radius","color","hexToColor","isHighlighted","fillColor","circle","fill","drawEyes","eyeSize","eyeOffset","eyeX1","eyeY1","eyeX2","eyeY2","pupilSize","event","location","getUILocation","deltaX","deltaY","dragThreshold","localPos","convertToNodeSpaceAR","clickedWorm","findWormAtPosition","handleWormClick","maxOffsetX","maxOffsetY","localX","localY","clickRadius","getAllSegments","segmentLocalX","segmentLocalY","dx","dy","distance","sqrt","playSound","obstacles","getObstacles","result","findPath","getLength","canEscape","moveWormToEscape","pathToObstacle","moveWormToObstacleAndBack","tryMoveWormOneStep","stack","excludeWorm","moveDuration","stepIndex","nextPos","isOnEscapePoint","some","ep","console","startMoveAnimation","maxExtraSteps","extraStep","extraPos","markEscaped","createEscapeEffect","checkVictory","wormLikeArray","w","hasCollision","checkCollision","handleCollision","finalPos","isFinalOutOfBounds","isFinalOnEscapePoint","getDirectionVector","lastPos","obstaclePos","flashWorm","originalSegments","reset","gameOver","headPos","setHighlighted","every","victory","completeLevel","scheduleOnce","showResult","sceneController","gameSceneController","node","levelLabel","string","heartNodes","sprite","ms","setTimeout","hex","exec","parseInt","restartLevel","returnToMenu","loadScene","nextLevel","nextLevelId","isLevelUnlocked"],"mappings":"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","sourcesContent":["/**\r\n * 游戏主控制器\r\n */\r\nimport { _decorator, Component, Node, director, Vec2, Vec3, instantiate, Prefab, \r\n    UITransform, Graphics, Color, Label, Sprite, SpriteFrame, resources, Canvas,\r\n    EventTouch, view, screen, Size, input, Input } from 'cc';\r\nimport { Worm, WormConfig } from './entities/Worm';\r\nimport { PathFinder } from './utils/PathFinder';\r\nimport { CollisionDetector, WormLike } from './utils/CollisionDetector';\r\nimport { LevelManager, LevelData } from './managers/LevelManager';\r\nimport { StorageManager } from './managers/StorageManager';\r\nimport { AudioManager } from './managers/AudioManager';\r\nimport { EffectManager } from './managers/EffectManager';\r\nimport { Logger } from './utils/Logger';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameController')\r\nexport class GameController extends Component {\r\n    @property(Node)\r\n    public gameArea: Node | null = null;\r\n\r\n    @property(Node)\r\n    public uiLayer: Node | null = null;\r\n\r\n    @property(Label)\r\n    public levelLabel: Label | null = null;\r\n\r\n    @property([Node])\r\n    public heartNodes: Node[] = [];\r\n\r\n    @property(Node)\r\n    public gameSceneController: Node | null = null;\r\n\r\n    @property\r\n    public cellSize: number = 60;\r\n\r\n    // 管理器\r\n    private levelManager: LevelManager | null = null;\r\n    private storageManager: StorageManager | null = null;\r\n    private audioManager: AudioManager | null = null;\r\n    private effectManager: EffectManager | null = null;\r\n\r\n    // 游戏状态\r\n    private worms: Worm[] = [];\r\n    private wormNodes: Node[] = [];\r\n    private matrix: { width: number; height: number } | null = null;\r\n    private escapePoints: Vec2[] = [];\r\n    private failCount: number = 3;\r\n    private isGameOver: boolean = false;\r\n    private isVictory: boolean = false;\r\n    private currentLevelId: number = 1;\r\n    private isWormsAppearing: boolean = false;\r\n    private isInitialized: boolean = false;\r\n\r\n    // 渲染相关\r\n    private offsetX: number = 0;\r\n    private offsetY: number = 0;\r\n    private graphics: Graphics | null = null;\r\n    private zoomScale: number = 1.0; // 缩放比例，默认1.0（100%）\r\n    \r\n    // 拖动相关\r\n    private isDragging: boolean = false;\r\n    private dragStartPos: Vec2 = new Vec2();\r\n    private dragStartOffset: Vec2 = new Vec2();\r\n    private mapOffsetX: number = 0; // 地图偏移量 X\r\n    private mapOffsetY: number = 0; // 地图偏移量 Y\r\n\r\n    // 图片资源\r\n    private wormHeadSprite: SpriteFrame | null = null;\r\n    private wormBodySprite: SpriteFrame | null = null;\r\n    private wormTailSprite: SpriteFrame | null = null;\r\n\r\n    protected onLoad() {\r\n        // 初始化管理器\r\n        this.levelManager = this.addComponent(LevelManager);\r\n        this.storageManager = this.addComponent(StorageManager);\r\n        this.audioManager = this.addComponent(AudioManager);\r\n        this.effectManager = this.addComponent(EffectManager);\r\n\r\n        this.storageManager.init();\r\n        this.audioManager.init(this.storageManager.getSettings());\r\n\r\n        // 加载蠕虫图片资源\r\n        this.loadWormImages();\r\n    }\r\n    \r\n    private gameAreaSetup: boolean = false;\r\n    \r\n    /**\r\n     * 设置游戏区域并注册事件（在 gameArea 被外部设置后调用）\r\n     */\r\n    private setupGameArea() {\r\n        if (!this.gameArea || this.gameAreaSetup) return;\r\n        \r\n        // 确保 UITransform 存在且有足够的尺寸\r\n        let uiTransform = this.gameArea.getComponent(UITransform);\r\n        if (!uiTransform) {\r\n            uiTransform = this.gameArea.addComponent(UITransform);\r\n        }\r\n        \r\n        // 如果尺寸为 0，设置默认尺寸\r\n        if (uiTransform.width === 0 || uiTransform.height === 0) {\r\n            // 尝试从父节点获取尺寸\r\n            const parentTransform = this.gameArea.parent?.getComponent(UITransform);\r\n            if (parentTransform && parentTransform.width > 0 && parentTransform.height > 0) {\r\n                uiTransform.width = parentTransform.width;\r\n                uiTransform.height = parentTransform.height;\r\n            } else {\r\n                // 使用默认尺寸\r\n                uiTransform.width = 720;\r\n                uiTransform.height = 1280;\r\n            }\r\n            Logger.log('设置 gameArea 默认尺寸:', uiTransform.width, 'x', uiTransform.height);\r\n        }\r\n        \r\n        // 创建 Graphics 组件用于绘制网格\r\n        this.graphics = this.gameArea.getComponent(Graphics);\r\n        if (!this.graphics) {\r\n            this.graphics = this.gameArea.addComponent(Graphics);\r\n        }\r\n\r\n        // 注册触摸事件\r\n        this.gameArea.on(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.gameArea.on(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.gameArea.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.gameArea.on(Input.EventType.TOUCH_CANCEL, this.onTouchCancel, this);\r\n        \r\n        Logger.log('触摸事件已注册到 gameArea, size=', uiTransform.width, 'x', uiTransform.height);\r\n        \r\n        this.gameAreaSetup = true;\r\n    }\r\n\r\n    /**\r\n     * 加载蠕虫图片资源\r\n     */\r\n    private async loadWormImages() {\r\n        try {\r\n            this.wormHeadSprite = await this.loadSpriteFrame('images/worm_head');\r\n            this.wormBodySprite = await this.loadSpriteFrame('images/worm_body');\r\n            this.wormTailSprite = await this.loadSpriteFrame('images/worm_tail');\r\n        } catch (e) {\r\n            Logger.warn('蠕虫图片资源加载失败，将使用默认绘制方式');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 加载 SpriteFrame\r\n     */\r\n    private loadSpriteFrame(path: string): Promise<SpriteFrame> {\r\n        return new Promise((resolve, reject) => {\r\n            resources.load(path + '/spriteFrame', SpriteFrame, (err, spriteFrame) => {\r\n                if (err) {\r\n                    reject(err);\r\n                } else {\r\n                    resolve(spriteFrame);\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 初始化游戏关卡\r\n     */\r\n    public async initLevel(levelId: number) {\r\n        // 暂停更新，防止在初始化过程中触发渲染\r\n        this.isInitialized = false;\r\n        \r\n        // 设置游戏区域（注册触摸事件）\r\n        this.setupGameArea();\r\n        \r\n        this.currentLevelId = levelId;\r\n        this.failCount = 3;\r\n        this.isGameOver = false;\r\n        this.isVictory = false;\r\n        this.worms = [];\r\n        this.wormNodes.forEach(n => n.destroy());\r\n        this.wormNodes = [];\r\n        this.escapePoints = [];\r\n\r\n        // 更新 UI\r\n        this.updateUI();\r\n\r\n        try {\r\n            // 加载关卡数据\r\n            const levelData = await this.levelManager!.loadLevel(levelId);\r\n            this.matrix = levelData.matrix;\r\n            this.escapePoints = levelData.escapePoints.map(p => new Vec2(p.x, p.y));\r\n\r\n            // 计算渲染参数\r\n            this.calculateRenderParams();\r\n\r\n            // 创建蠕虫对象\r\n            for (const wormConfig of levelData.worms) {\r\n                const wormNode = new Node(`Worm_${wormConfig.id}`);\r\n                wormNode.parent = this.gameArea;\r\n                const worm = wormNode.addComponent(Worm);\r\n                worm.init(wormConfig);\r\n                worm.setVisibleSegmentCount(0);\r\n                this.worms.push(worm);\r\n                this.wormNodes.push(wormNode);\r\n                Logger.log(`蠕虫 ${worm.id} 创建: 头部=(${worm.getHeadPosition().x}, ${worm.getHeadPosition().y}), 方向=${worm.direction}, 段数=${worm.segments.length}`);\r\n            }\r\n\r\n            // 绘制网格\r\n            this.drawGrid();\r\n\r\n            // 逐个显示蠕虫\r\n            await this.animateWormsAppearance();\r\n            \r\n            // 初始化完成\r\n            this.isInitialized = true;\r\n\r\n        } catch (error) {\r\n            Logger.error('初始化游戏场景失败:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 计算渲染参数\r\n     */\r\n    private calculateRenderParams() {\r\n        if (!this.matrix || !this.gameArea) return;\r\n\r\n        const transform = this.gameArea.getComponent(UITransform);\r\n        if (!transform) return;\r\n\r\n        const areaWidth = transform.width;\r\n        const areaHeight = transform.height;\r\n\r\n        // 计算基础 cellSize（不考虑缩放）\r\n        const baseCellSizeX = areaWidth / this.matrix.width;\r\n        const baseCellSizeY = areaHeight / this.matrix.height;\r\n        const baseCellSize = Math.min(baseCellSizeX, baseCellSizeY) * 0.9;\r\n\r\n        // 应用缩放比例\r\n        this.cellSize = baseCellSize * this.zoomScale;\r\n\r\n        // 计算偏移量使网格居中，并加上拖动偏移\r\n        const gridWidth = this.matrix.width * this.cellSize;\r\n        const gridHeight = this.matrix.height * this.cellSize;\r\n        const centerOffsetX = (areaWidth - gridWidth) / 2 - areaWidth / 2;\r\n        const centerOffsetY = (areaHeight - gridHeight) / 2 - areaHeight / 2;\r\n        this.offsetX = centerOffsetX + this.mapOffsetX;\r\n        this.offsetY = centerOffsetY + this.mapOffsetY;\r\n        \r\n        Logger.log('渲染参数: areaSize=', areaWidth, 'x', areaHeight, \r\n            ' cellSize=', this.cellSize, ' zoomScale=', this.zoomScale, ' offset=', this.offsetX, this.offsetY);\r\n    }\r\n\r\n    /**\r\n     * 设置缩放比例\r\n     * @param scale 缩放比例（0.5-1.5）\r\n     */\r\n    public setZoomScale(scale: number) {\r\n        // 限制缩放范围\r\n        this.zoomScale = Math.max(0.5, Math.min(1.5, scale));\r\n        \r\n        // 重新计算渲染参数\r\n        this.calculateRenderParams();\r\n        \r\n        // 限制拖动范围（缩放后可能需要调整）\r\n        this.limitDragRange();\r\n        this.calculateRenderParams(); // 重新计算一次以确保偏移正确\r\n        \r\n        // 重新绘制网格\r\n        if (this.matrix) {\r\n            this.drawGrid();\r\n        }\r\n        \r\n        // 更新蠕虫显示\r\n        this.updateWormVisuals();\r\n    }\r\n\r\n    /**\r\n     * 重置地图位置（居中显示）\r\n     */\r\n    public resetMapPosition() {\r\n        this.mapOffsetX = 0;\r\n        this.mapOffsetY = 0;\r\n        this.calculateRenderParams();\r\n        if (this.matrix) {\r\n            this.drawGrid();\r\n        }\r\n        this.updateWormVisuals();\r\n    }\r\n\r\n    /**\r\n     * 获取当前缩放比例\r\n     */\r\n    public getZoomScale(): number {\r\n        return this.zoomScale;\r\n    }\r\n\r\n    /**\r\n     * 绘制网格\r\n     */\r\n    private drawGrid() {\r\n        if (!this.graphics || !this.matrix) return;\r\n\r\n        this.graphics.clear();\r\n        this.graphics.strokeColor = new Color(224, 224, 224, 255);\r\n        this.graphics.lineWidth = 1;\r\n\r\n        // 绘制垂直网格线\r\n        for (let x = 0; x <= this.matrix.width; x++) {\r\n            const screenX = this.offsetX + x * this.cellSize;\r\n            this.graphics.moveTo(screenX, this.offsetY);\r\n            this.graphics.lineTo(screenX, this.offsetY + this.matrix.height * this.cellSize);\r\n        }\r\n\r\n        // 绘制水平网格线\r\n        for (let y = 0; y <= this.matrix.height; y++) {\r\n            const screenY = this.offsetY + y * this.cellSize;\r\n            this.graphics.moveTo(this.offsetX, screenY);\r\n            this.graphics.lineTo(this.offsetX + this.matrix.width * this.cellSize, screenY);\r\n        }\r\n\r\n        this.graphics.stroke();\r\n    }\r\n\r\n    /**\r\n     * 世界坐标转屏幕坐标\r\n     */\r\n    private worldToScreen(x: number, y: number): Vec3 {\r\n        return new Vec3(\r\n            this.offsetX + (x + 0.5) * this.cellSize,\r\n            -(this.offsetY + (y + 0.5) * this.cellSize),\r\n            0\r\n        );\r\n    }\r\n\r\n    /**\r\n     * 屏幕坐标转世界坐标\r\n     */\r\n    private screenToWorld(screenX: number, screenY: number): Vec2 {\r\n        const x = Math.floor((screenX - this.offsetX) / this.cellSize);\r\n        const y = Math.floor((-screenY - this.offsetY) / this.cellSize);\r\n        return new Vec2(x, y);\r\n    }\r\n\r\n    /**\r\n     * 检查位置是否是有效的逃脱位置\r\n     * 逃脱位置应该在矩阵边界外，但不要太远（不超过边界1-2格）\r\n     */\r\n    private isValidEscapePosition(pos: Vec2): boolean {\r\n        if (!this.matrix) {\r\n            return false;\r\n        }\r\n\r\n        const matrixWidth = this.matrix.width;\r\n        const matrixHeight = this.matrix.height;\r\n        const maxDistance = 2; // 允许的最大距离（从边界算起）\r\n\r\n        // 检查是否在矩阵边界外\r\n        const isOutOfBounds = !CollisionDetector.isInBounds(pos, matrixWidth, matrixHeight);\r\n        if (!isOutOfBounds) {\r\n            return false;\r\n        }\r\n\r\n        // 检查是否在合理的逃脱范围内（不超过边界太远）\r\n        // x 方向：应该在 -maxDistance 到 matrixWidth + maxDistance 之间\r\n        // y 方向：应该在 -maxDistance 到 matrixHeight + maxDistance 之间\r\n        const xInRange = pos.x >= -maxDistance && pos.x < matrixWidth + maxDistance;\r\n        const yInRange = pos.y >= -maxDistance && pos.y < matrixHeight + maxDistance;\r\n\r\n        return xInRange && yInRange;\r\n    }\r\n\r\n    /**\r\n     * 动画显示蠕虫\r\n     */\r\n    private async animateWormsAppearance() {\r\n        this.isWormsAppearing = true;\r\n        const segmentInterval = 50;\r\n\r\n        // 安全检查：确保 worms 是数组\r\n        if (!Array.isArray(this.worms) || this.worms.length === 0) {\r\n            Logger.warn('animateWormsAppearance: worms 不是数组或为空');\r\n            this.isWormsAppearing = false;\r\n            return;\r\n        }\r\n\r\n        let maxSegments = 0;\r\n        for (const worm of this.worms) {\r\n            if (worm && worm.segments) {\r\n                maxSegments = Math.max(maxSegments, worm.segments.length);\r\n            }\r\n        }\r\n\r\n        for (let segmentIndex = 1; segmentIndex <= maxSegments; segmentIndex++) {\r\n            for (const worm of this.worms) {\r\n                if (worm && worm.segments && segmentIndex <= worm.segments.length) {\r\n                    worm.setVisibleSegmentCount(segmentIndex);\r\n                }\r\n            }\r\n            this.updateWormVisuals();\r\n            await this.wait(segmentInterval);\r\n        }\r\n\r\n        for (const worm of this.worms) {\r\n            if (worm && worm.segments) {\r\n                worm.setVisibleSegmentCount(worm.segments.length);\r\n            }\r\n        }\r\n\r\n        this.isWormsAppearing = false;\r\n    }\r\n\r\n    /**\r\n     * 更新蠕虫可视化\r\n     */\r\n    protected update(dt: number) {\r\n        if (this.isInitialized && this.worms.length > 0) {\r\n            this.updateWormVisuals();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新蠕虫可视化\r\n     */\r\n    private updateWormVisuals() {\r\n        // 安全检查：确保 worms 是数组\r\n        if (!Array.isArray(this.worms) || !Array.isArray(this.wormNodes)) {\r\n            return;\r\n        }\r\n\r\n        for (let i = 0; i < this.worms.length; i++) {\r\n            const worm = this.worms[i];\r\n            const wormNode = this.wormNodes[i];\r\n\r\n            // 安全检查\r\n            if (!worm || !wormNode) {\r\n                continue;\r\n            }\r\n\r\n            if (worm.hasEscaped()) {\r\n                wormNode.active = false;\r\n                continue;\r\n            }\r\n\r\n            // 确保蠕虫节点是激活的\r\n            if (!wormNode.active) {\r\n                Logger.log(`激活蠕虫节点 ${worm.id}`);\r\n                wormNode.active = true;\r\n            }\r\n\r\n            // 获取插值后的段位置\r\n            const segments = worm.getInterpolatedSegments();\r\n            const visibleCount = worm.visibleSegmentCount;\r\n            \r\n            // 调试：检查段数据\r\n            if (!segments || segments.length === 0) {\r\n                Logger.error(`错误：蠕虫 ${worm.id} 的 segments 为空！`);\r\n                continue;\r\n            }\r\n            \r\n            if (visibleCount === 0 && !worm.hasEscaped()) {\r\n                Logger.warn(`警告：蠕虫 ${worm.id} 的 visibleCount=0，但未逃脱！`);\r\n            }\r\n\r\n            // 更新每个段的位置\r\n            this.renderWormSegments(wormNode, worm, segments, visibleCount);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * 调试：打印渲染状态\r\n     */\r\n    private logRenderState(worm: Worm) {\r\n        const segments = worm.getInterpolatedSegments();\r\n        const head = segments[0];\r\n        const screenPos = this.worldToScreen(head.x, head.y);\r\n        Logger.log(`渲染蠕虫 ${worm.id}: segments=${segments.length}, visible=${worm.visibleSegmentCount}, head=(${head.x}, ${head.y}), screen=(${screenPos.x.toFixed(0)}, ${screenPos.y.toFixed(0)}), animating=${worm.isAnimating}, cellSize=${this.cellSize.toFixed(1)}, offset=(${this.offsetX.toFixed(0)}, ${this.offsetY.toFixed(0)})`);\r\n    }\r\n    \r\n    /**\r\n     * 调试：打印蠕虫状态\r\n     */\r\n    public debugWormState() {\r\n        Logger.log('=== 蠕虫状态 ===');\r\n        if (!Array.isArray(this.worms)) {\r\n            Logger.log('worms 不是数组');\r\n            return;\r\n        }\r\n        for (const worm of this.worms) {\r\n            Logger.log(`蠕虫 ${worm.id}: escaped=${worm.isEscaped}, escaping=${worm.isEscaping}, animating=${worm.isAnimating}, segments=${worm.segments.length}, visible=${worm.visibleSegmentCount}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 渲染蠕虫段\r\n     */\r\n    private renderWormSegments(wormNode: Node, worm: Worm, segments: Vec2[], visibleCount: number) {\r\n        // 确保有足够的子节点\r\n        const currentCount = wormNode.children.length;\r\n        for (let idx = currentCount; idx < segments.length; idx++) {\r\n            const segmentNode = new Node(`Segment_${idx}`);\r\n            \r\n            // 先添加 UITransform\r\n            const transform = segmentNode.addComponent(UITransform);\r\n            // 再添加 Graphics 组件用于绘制\r\n            const graphics = segmentNode.addComponent(Graphics);\r\n            \r\n            // 最后设置 parent，避免在设置 parent 时触发额外逻辑\r\n            segmentNode.parent = wormNode;\r\n        }\r\n\r\n        // 更新每个段\r\n        for (let i = 0; i < segments.length; i++) {\r\n            const segmentNode = wormNode.children[i];\r\n            const isVisible = i >= (segments.length - visibleCount);\r\n            segmentNode.active = isVisible;\r\n            \r\n            // 调试：如果蠕虫应该可见但被隐藏了\r\n            if (i === 0 && !isVisible && !worm.hasEscaped()) {\r\n               // Logger.warn(`警告：蠕虫 ${worm.id} 头部被隐藏！segments.length=${segments.length}, visibleCount=${visibleCount}, isVisible=${isVisible}`);\r\n            }\r\n\r\n            if (!isVisible) continue;\r\n\r\n            const segment = segments[i];\r\n            const screenPos = this.worldToScreen(segment.x, segment.y);\r\n            segmentNode.setPosition(screenPos);\r\n            \r\n            // 调试：检查坐标是否在合理范围内\r\n            if (i === 0) {\r\n                const transform = this.gameArea?.getComponent(UITransform);\r\n                if (transform) {\r\n                    const halfWidth = transform.width / 2;\r\n                    const halfHeight = transform.height / 2;\r\n                    if (Math.abs(screenPos.x) > halfWidth * 2 || Math.abs(screenPos.y) > halfHeight * 2) {\r\n                        //Logger.warn(`警告：蠕虫 ${worm.id} 头部坐标超出屏幕范围！world=(${segment.x}, ${segment.y}) screen=(${screenPos.x.toFixed(0)}, ${screenPos.y.toFixed(0)}), 屏幕范围=(${halfWidth}, ${halfHeight})`);\r\n                    }\r\n                }\r\n            }\r\n\r\n            // 绘制段\r\n            const graphics = segmentNode.getComponent(Graphics);\r\n            if (graphics) {\r\n                graphics.clear();\r\n                \r\n                const radius = this.cellSize * 0.4;\r\n                const color = this.hexToColor(worm.color);\r\n                \r\n                if (worm.isHighlighted) {\r\n                    graphics.fillColor = new Color(255, 100, 100, 255);\r\n                } else {\r\n                    graphics.fillColor = color;\r\n                }\r\n                \r\n                graphics.circle(0, 0, radius);\r\n                graphics.fill();\r\n\r\n                // 绘制眼睛（头部）\r\n                if (i === 0) {\r\n                    this.drawEyes(graphics, worm.direction, radius);\r\n                }\r\n            }\r\n        }\r\n\r\n        // 隐藏多余的节点\r\n        for (let i = segments.length; i < wormNode.children.length; i++) {\r\n            wormNode.children[i].active = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 绘制眼睛\r\n     */\r\n    private drawEyes(graphics: Graphics, direction: string, radius: number) {\r\n        graphics.fillColor = new Color(255, 255, 255, 255);\r\n        const eyeSize = radius * 0.35;\r\n        const eyeOffset = radius * 0.35;\r\n\r\n        let eyeX1: number, eyeY1: number, eyeX2: number, eyeY2: number;\r\n\r\n        switch (direction) {\r\n            case 'left':\r\n                eyeX1 = -eyeOffset; eyeY1 = -eyeOffset;\r\n                eyeX2 = -eyeOffset; eyeY2 = eyeOffset;\r\n                break;\r\n            case 'right':\r\n                eyeX1 = eyeOffset; eyeY1 = -eyeOffset;\r\n                eyeX2 = eyeOffset; eyeY2 = eyeOffset;\r\n                break;\r\n            case 'up':\r\n                eyeX1 = -eyeOffset; eyeY1 = eyeOffset;\r\n                eyeX2 = eyeOffset; eyeY2 = eyeOffset;\r\n                break;\r\n            case 'down':\r\n            default:\r\n                eyeX1 = -eyeOffset; eyeY1 = -eyeOffset;\r\n                eyeX2 = eyeOffset; eyeY2 = -eyeOffset;\r\n                break;\r\n        }\r\n\r\n        // 白色眼睛\r\n        graphics.circle(eyeX1, eyeY1, eyeSize);\r\n        graphics.fill();\r\n        graphics.circle(eyeX2, eyeY2, eyeSize);\r\n        graphics.fill();\r\n\r\n        // 黑色眼珠\r\n        graphics.fillColor = new Color(0, 0, 0, 255);\r\n        const pupilSize = eyeSize * 0.5;\r\n        graphics.circle(eyeX1, eyeY1, pupilSize);\r\n        graphics.fill();\r\n        graphics.circle(eyeX2, eyeY2, pupilSize);\r\n        graphics.fill();\r\n    }\r\n\r\n    /**\r\n     * 处理触摸开始事件\r\n     */\r\n    private onTouchStart(event: EventTouch) {\r\n        if (this.isGameOver || this.isVictory || this.isWormsAppearing) {\r\n            return;\r\n        }\r\n\r\n        const location = event.getUILocation();\r\n        this.dragStartPos = new Vec2(location.x, location.y);\r\n        this.dragStartOffset = new Vec2(this.mapOffsetX, this.mapOffsetY);\r\n        this.isDragging = false;\r\n    }\r\n\r\n    /**\r\n     * 处理触摸移动事件\r\n     */\r\n    private onTouchMove(event: EventTouch) {\r\n        if (this.isGameOver || this.isVictory || this.isWormsAppearing) {\r\n            return;\r\n        }\r\n\r\n        const location = event.getUILocation();\r\n        const deltaX = location.x - this.dragStartPos.x;\r\n        const deltaY = location.y - this.dragStartPos.y;\r\n        \r\n        // 如果移动距离超过阈值，认为是拖动\r\n        const dragThreshold = 10; // 拖动阈值（像素）\r\n        if (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold) {\r\n            this.isDragging = true;\r\n            \r\n            // 更新地图偏移量\r\n            this.mapOffsetX = this.dragStartOffset.x + deltaX;\r\n            this.mapOffsetY = this.dragStartOffset.y - deltaY; // Y轴需要反转\r\n            \r\n            // 限制拖动范围（可选，根据实际需求调整）\r\n            this.limitDragRange();\r\n            \r\n            // 重新计算渲染参数并更新显示\r\n            this.calculateRenderParams();\r\n            if (this.matrix) {\r\n                this.drawGrid();\r\n            }\r\n            this.updateWormVisuals();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理触摸结束事件\r\n     */\r\n    private onTouchEnd(event: EventTouch) {\r\n        if (this.isGameOver || this.isVictory || this.isWormsAppearing) {\r\n            Logger.log('触摸被忽略: isGameOver=', this.isGameOver, 'isVictory=', this.isVictory, 'isWormsAppearing=', this.isWormsAppearing);\r\n            return;\r\n        }\r\n\r\n        // 如果是拖动，不处理点击\r\n        if (this.isDragging) {\r\n            this.isDragging = false;\r\n            return;\r\n        }\r\n\r\n        const location = event.getUILocation();\r\n        const transform = this.gameArea?.getComponent(UITransform);\r\n        if (!transform) {\r\n            Logger.log('transform 不存在');\r\n            return;\r\n        }\r\n\r\n        // 转换为节点本地坐标（考虑地图偏移）\r\n        const localPos = transform.convertToNodeSpaceAR(new Vec3(location.x, location.y, 0));\r\n        Logger.log('触摸位置: UI=', location.x, location.y, ' Local=', localPos.x, localPos.y);\r\n        \r\n        // 查找点击的蠕虫\r\n        const clickedWorm = this.findWormAtPosition(localPos.x, localPos.y);\r\n        if (clickedWorm) {\r\n            Logger.log('找到蠕虫:', clickedWorm.id, 'escaped=', clickedWorm.hasEscaped(), 'animating=', clickedWorm.isAnimating);\r\n            if (!clickedWorm.hasEscaped() && !clickedWorm.isAnimating) {\r\n                this.handleWormClick(clickedWorm);\r\n            }\r\n        } else {\r\n            Logger.log('没有找到蠕虫');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理触摸取消事件\r\n     */\r\n    private onTouchCancel(event: EventTouch) {\r\n        this.isDragging = false;\r\n    }\r\n\r\n    /**\r\n     * 限制拖动范围\r\n     */\r\n    private limitDragRange() {\r\n        if (!this.matrix || !this.gameArea) return;\r\n\r\n        const transform = this.gameArea.getComponent(UITransform);\r\n        if (!transform) return;\r\n\r\n        const areaWidth = transform.width;\r\n        const areaHeight = transform.height;\r\n\r\n        // 计算网格的实际尺寸\r\n        const gridWidth = this.matrix.width * this.cellSize;\r\n        const gridHeight = this.matrix.height * this.cellSize;\r\n\r\n        // 限制拖动范围，确保地图不会移出屏幕太远\r\n        const maxOffsetX = Math.max(0, (gridWidth - areaWidth) / 2);\r\n        const maxOffsetY = Math.max(0, (gridHeight - areaHeight) / 2);\r\n\r\n        this.mapOffsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, this.mapOffsetX));\r\n        this.mapOffsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, this.mapOffsetY));\r\n    }\r\n\r\n    /**\r\n     * 查找点击位置的蠕虫\r\n     */\r\n    private findWormAtPosition(localX: number, localY: number): Worm | null {\r\n        const clickRadius = this.cellSize * 0.6;\r\n\r\n        if (!Array.isArray(this.worms)) {\r\n            return null;\r\n        }\r\n\r\n        for (const worm of this.worms) {\r\n            if (worm.hasEscaped()) continue;\r\n\r\n            for (const segment of worm.getAllSegments()) {\r\n                // 计算蠕虫段在本地坐标系中的位置\r\n                const segmentLocalX = this.offsetX + (segment.x + 0.5) * this.cellSize;\r\n                const segmentLocalY = -(this.offsetY + (segment.y + 0.5) * this.cellSize);\r\n                \r\n                const dx = localX - segmentLocalX;\r\n                const dy = localY - segmentLocalY;\r\n                const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n                if (distance <= clickRadius) {\r\n                    return worm;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * 处理蠕虫点击\r\n     */\r\n    private async handleWormClick(worm: Worm) {\r\n        Logger.log('处理蠕虫点击: id=', worm.id, ' head=', worm.getHeadPosition(), ' dir=', worm.direction);\r\n        this.audioManager?.playSound('click');\r\n\r\n        // 获取障碍物\r\n        const obstacles = this.getObstacles(worm);\r\n        Logger.log('障碍物数量:', obstacles.length);\r\n\r\n        // 查找逃脱路径\r\n        const result = PathFinder.findPath(\r\n            worm.getHeadPosition(),\r\n            worm.direction,\r\n            worm.getLength(),\r\n            worm.getAllSegments(),\r\n            this.matrix!.width,\r\n            this.matrix!.height,\r\n            obstacles,\r\n            this.escapePoints\r\n        );\r\n        Logger.log('路径查找结果: canEscape=', result.canEscape, ' pathLen=', result.path.length);\r\n\r\n        try {\r\n            if (result.canEscape && result.path.length > 0) {\r\n                Logger.log('蠕虫开始逃脱');\r\n                await this.moveWormToEscape(worm, result.path);\r\n                Logger.log('蠕虫逃脱流程完成');\r\n            } else if (!result.canEscape && result.pathToObstacle && result.pathToObstacle.length > 0) {\r\n                Logger.log('蠕虫碰到障碍物，后退');\r\n                await this.moveWormToObstacleAndBack(worm, result.pathToObstacle);\r\n                Logger.log('蠕虫后退流程完成');\r\n            } else {\r\n                Logger.log('尝试向前移动一步');\r\n                await this.tryMoveWormOneStep(worm);\r\n                Logger.log('移动一步流程完成');\r\n            }\r\n        } catch (error) {\r\n            Logger.error('处理蠕虫移动时发生错误:', error);\r\n            Logger.error('错误堆栈:', error.stack);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 获取障碍物\r\n     */\r\n    private getObstacles(excludeWorm: Worm): Vec2[] {\r\n        const obstacles: Vec2[] = [];\r\n        if (!Array.isArray(this.worms)) {\r\n            return obstacles;\r\n        }\r\n        for (const worm of this.worms) {\r\n            if (worm.id === excludeWorm.id || worm.hasEscaped() || worm.isEscaping || worm.isAnimating) {\r\n                continue;\r\n            }\r\n            obstacles.push(...worm.getAllSegments());\r\n        }\r\n        return obstacles;\r\n    }\r\n\r\n    /**\r\n     * 移动蠕虫逃脱\r\n     */\r\n    private async moveWormToEscape(worm: Worm, path: Vec2[]) {\r\n        try {\r\n            Logger.log(`蠕虫 ${worm.id} 开始逃脱，路径长度=${path.length}`);\r\n            worm.isEscaping = true;\r\n            const moveDuration = 80;\r\n\r\n            for (let stepIndex = 0; stepIndex < path.length; stepIndex++) {\r\n                const nextPos = path[stepIndex];\r\n                Logger.log(`蠕虫 ${worm.id} 步骤 ${stepIndex + 1}/${path.length}: 移动到 (${nextPos.x}, ${nextPos.y})`);\r\n                \r\n                // 检查是否在边界外（可以逃脱）\r\n                // 边界外应该是紧邻矩阵边界的位置，不应该太远\r\n                const isOutOfBounds = this.isValidEscapePosition(nextPos);\r\n                // 检查是否在逃脱点上（逃脱点必须在边界外才有效）\r\n                const isOnEscapePoint = isOutOfBounds && this.escapePoints.some(ep => ep.x === nextPos.x && ep.y === nextPos.y);\r\n                \r\n                console.log(`蠕虫 ${worm.id} 步骤 ${stepIndex + 1}: 边界外=${isOutOfBounds}, 逃脱点=${isOnEscapePoint}, 位置=(${nextPos.x}, ${nextPos.y})`);\r\n                \r\n                // 只有真正在边界外时才能逃脱\r\n                if (isOutOfBounds) {\r\n                    Logger.log(`蠕虫 ${worm.id} 在步骤 ${stepIndex + 1} 到达逃脱位置，开始逃脱`);\r\n                    await worm.startMoveAnimation(nextPos, moveDuration);\r\n                    this.audioManager?.playSound('move');\r\n                    \r\n                    // 继续移动剩余步数，让整个蠕虫都离开屏幕\r\n                    // 但限制额外步数，避免移动到过远的位置\r\n                    const maxExtraSteps = Math.min(worm.getLength(), 10); // 最多额外移动10步或蠕虫长度\r\n                    for (let extraStep = stepIndex + 1; extraStep < path.length && (extraStep - stepIndex) <= maxExtraSteps; extraStep++) {\r\n                        const extraPos = path[extraStep];\r\n                        // 检查额外位置是否在合理范围内（不超过边界太远）\r\n                        if (this.isValidEscapePosition(extraPos)) {\r\n                            Logger.log(`蠕虫 ${worm.id} 额外步骤: 移动到 (${extraPos.x}, ${extraPos.y})`);\r\n                            await worm.startMoveAnimation(extraPos, moveDuration);\r\n                        } else {\r\n                            break; // 如果位置太远，停止移动\r\n                        }\r\n                    }\r\n                    \r\n                    // 标记为逃脱\r\n                    Logger.log(`蠕虫 ${worm.id} 逃脱完成`);\r\n                    worm.isEscaping = false;\r\n                    worm.markEscaped();\r\n                    this.audioManager?.playSound('escape');\r\n                    this.effectManager?.createEscapeEffect(\r\n                        this.worldToScreen(worm.getHeadPosition().x, worm.getHeadPosition().y),\r\n                        worm.color\r\n                    );\r\n                    this.checkVictory();\r\n                    return;\r\n                }\r\n                \r\n                // 检查碰撞\r\n                if (!Array.isArray(this.worms)) {\r\n                    Logger.error('worms 不是数组，无法检查碰撞');\r\n                    return;\r\n                }\r\n                const wormLikeArray = this.worms.map(w => ({\r\n                    id: w.id,\r\n                    segments: w.segments,\r\n                    direction: w.direction,\r\n                    isEscaped: w.isEscaped,\r\n                    isEscaping: w.isEscaping,\r\n                    isAnimating: w.isAnimating\r\n                }));\r\n\r\n                const hasCollision = CollisionDetector.checkCollision({\r\n                    id: worm.id,\r\n                    segments: worm.segments,\r\n                    direction: worm.direction,\r\n                    isEscaped: worm.isEscaped,\r\n                    isEscaping: worm.isEscaping,\r\n                    isAnimating: worm.isAnimating\r\n                }, nextPos, wormLikeArray);\r\n                \r\n                Logger.log(`蠕虫 ${worm.id} 步骤 ${stepIndex + 1}: 碰撞检测结果=${hasCollision}`);\r\n                \r\n                if (hasCollision) {\r\n                    Logger.log(`蠕虫 ${worm.id} 在步骤 ${stepIndex + 1} 发生碰撞，调用 handleCollision`);\r\n                    await this.handleCollision(worm);\r\n                    Logger.log(`蠕虫 ${worm.id} handleCollision 完成`);\r\n                    return;\r\n                }\r\n\r\n                Logger.log(`蠕虫 ${worm.id} 步骤 ${stepIndex + 1}: 开始移动动画`);\r\n                await worm.startMoveAnimation(nextPos, moveDuration);\r\n                Logger.log(`蠕虫 ${worm.id} 步骤 ${stepIndex + 1}: 移动动画完成`);\r\n                this.audioManager?.playSound('move');\r\n            }\r\n\r\n            // 如果走完所有路径但还在矩阵内，说明路径计算有问题，不应该逃脱\r\n            const finalPos = worm.getHeadPosition();\r\n            const isFinalOutOfBounds = this.isValidEscapePosition(finalPos);\r\n            const isFinalOnEscapePoint = isFinalOutOfBounds && this.escapePoints.some(ep => ep.x === finalPos.x && ep.y === finalPos.y);\r\n            \r\n            console.log(`蠕虫 ${worm.id} 路径走完: 最终位置=(${finalPos.x}, ${finalPos.y}), 边界外=${isFinalOutOfBounds}, 逃脱点=${isFinalOnEscapePoint}`);\r\n            \r\n            // 只有真正在边界外时才能逃脱\r\n            if (isFinalOutOfBounds) {\r\n                // 标记为逃脱\r\n                Logger.log(`蠕虫 ${worm.id} 逃脱完成`);\r\n                worm.isEscaping = false;\r\n                worm.markEscaped();\r\n                this.audioManager?.playSound('escape');\r\n                this.effectManager?.createEscapeEffect(\r\n                    this.worldToScreen(worm.getHeadPosition().x, worm.getHeadPosition().y),\r\n                    worm.color\r\n                );\r\n                this.checkVictory();\r\n            } else {\r\n                Logger.warn(`蠕虫 ${worm.id} 路径走完但仍在矩阵内，不应该逃脱！`);\r\n                // 不应该逃脱，重置蠕虫\r\n                worm.isEscaping = false;\r\n                await this.handleCollision(worm);\r\n            }\r\n        } catch (error) {\r\n            Logger.error(`蠕虫 ${worm.id} 逃脱过程中发生错误:`, error);\r\n            Logger.error('错误堆栈:', error.stack);\r\n            worm.isEscaping = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 移动蠕虫到障碍物并返回\r\n     */\r\n    private async moveWormToObstacleAndBack(worm: Worm, pathToObstacle: Vec2[]) {\r\n        Logger.log(`蠕虫 ${worm.id} 移动到障碍物: pathLen=${pathToObstacle.length}`);\r\n        const moveDuration = 60;\r\n        const direction = PathFinder.getDirectionVector(worm.direction);\r\n\r\n        // 移动到障碍物位置\r\n        for (const pos of pathToObstacle) {\r\n            await worm.startMoveAnimation(pos, moveDuration);\r\n        }\r\n\r\n        // 再移动一步到障碍物\r\n        const lastPos = pathToObstacle.length > 0 \r\n            ? pathToObstacle[pathToObstacle.length - 1] \r\n            : worm.getHeadPosition();\r\n        const obstaclePos = new Vec2(lastPos.x + direction.x, lastPos.y + direction.y);\r\n        await worm.startMoveAnimation(obstaclePos, moveDuration);\r\n\r\n        this.audioManager?.playSound('collision');\r\n\r\n        // 高亮闪烁\r\n        await this.flashWorm(worm);\r\n\r\n        // 返回原位\r\n        Logger.log(`蠕虫 ${worm.id} 重置到原位`);\r\n        Logger.log(`原始位置: originalSegments[0]=(${worm.originalSegments[0]?.x}, ${worm.originalSegments[0]?.y}), length=${worm.originalSegments.length}`);\r\n        worm.reset();\r\n        this.logRenderState(worm);\r\n        \r\n        // 强制刷新渲染\r\n        this.updateWormVisuals();\r\n        \r\n        // 等待一帧确保渲染更新\r\n        await this.wait(16);\r\n        this.updateWormVisuals();\r\n\r\n        this.failCount--;\r\n        this.updateUI();\r\n\r\n        if (this.failCount <= 0) {\r\n            this.gameOver();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 尝试移动蠕虫一步\r\n     */\r\n    private async tryMoveWormOneStep(worm: Worm) {\r\n        const headPos = worm.getHeadPosition();\r\n        const direction = PathFinder.getDirectionVector(worm.direction);\r\n        const nextPos = new Vec2(headPos.x + direction.x, headPos.y + direction.y);\r\n\r\n        // 检查边界\r\n        const isOutOfBounds = this.isValidEscapePosition(nextPos);\r\n        // 检查是否在逃脱点上（逃脱点必须在边界外才有效）\r\n        const isOnEscapePoint = isOutOfBounds && this.escapePoints.some(ep => ep.x === nextPos.x && ep.y === nextPos.y);\r\n        \r\n        // 只有真正在边界外时才能逃脱\r\n        if (isOutOfBounds) {\r\n            // 可以逃脱\r\n            console.log(`边界外=${isOutOfBounds}, 逃脱点=${isOnEscapePoint}, 位置=(${nextPos.x}, ${nextPos.y}), 蠕虫逃脱`);\r\n            await worm.startMoveAnimation(nextPos, 80);\r\n            worm.markEscaped();\r\n            this.audioManager?.playSound('escape');\r\n            this.effectManager?.createEscapeEffect(\r\n                this.worldToScreen(nextPos.x, nextPos.y),\r\n                worm.color\r\n            );\r\n            this.checkVictory();\r\n            return;\r\n        }\r\n\r\n        // 检查碰撞\r\n        const wormLikeArray = this.worms.map(w => ({\r\n            id: w.id,\r\n            segments: w.segments,\r\n            direction: w.direction,\r\n            isEscaped: w.isEscaped,\r\n            isEscaping: w.isEscaping,\r\n            isAnimating: w.isAnimating\r\n        }));\r\n\r\n        if (CollisionDetector.checkCollision({\r\n            id: worm.id,\r\n            segments: worm.segments,\r\n            direction: worm.direction,\r\n            isEscaped: worm.isEscaped,\r\n            isEscaping: worm.isEscaping,\r\n            isAnimating: worm.isAnimating\r\n        }, nextPos, wormLikeArray)) {\r\n            Logger.log('发生碰撞');\r\n            await this.handleCollision(worm);\r\n        } else {\r\n            // 没有碰撞，正常移动一步\r\n            Logger.log('正常移动一步到', nextPos.x, nextPos.y);\r\n            await worm.startMoveAnimation(nextPos, 80);\r\n            this.audioManager?.playSound('move');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理碰撞\r\n     */\r\n    private async handleCollision(worm: Worm) {\r\n        Logger.log(`碰撞处理开始: 蠕虫 ${worm.id}, 当前头部=(${worm.getHeadPosition().x}, ${worm.getHeadPosition().y})`);\r\n        this.audioManager?.playSound('collision');\r\n        await this.flashWorm(worm);\r\n        Logger.log(`闪烁完成，准备重置`);\r\n        Logger.log(`原始位置: originalSegments[0]=(${worm.originalSegments[0]?.x}, ${worm.originalSegments[0]?.y}), length=${worm.originalSegments.length}`);\r\n        worm.reset();\r\n        worm.isEscaping = false;\r\n        Logger.log(`重置完成: isEscaped=${worm.isEscaped}, segments=${worm.segments.length}, head=(${worm.getHeadPosition().x}, ${worm.getHeadPosition().y})`);\r\n        this.logRenderState(worm);\r\n        \r\n        // 强制刷新渲染\r\n        this.updateWormVisuals();\r\n        \r\n        // 等待一帧确保渲染更新\r\n        await this.wait(16);\r\n        this.updateWormVisuals();\r\n\r\n        this.failCount--;\r\n        this.updateUI();\r\n\r\n        if (this.failCount <= 0) {\r\n            this.gameOver();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 蠕虫闪烁效果\r\n     */\r\n    private async flashWorm(worm: Worm): Promise<void> {\r\n        for (let i = 0; i < 6; i++) {\r\n            worm.setHighlighted(i % 2 === 0);\r\n            await this.wait(100);\r\n        }\r\n        worm.setHighlighted(false);\r\n    }\r\n\r\n    /**\r\n     * 检查胜利\r\n     */\r\n    private checkVictory() {\r\n        if (!Array.isArray(this.worms) || this.worms.length === 0) {\r\n            return;\r\n        }\r\n        if (this.worms.every(worm => worm.hasEscaped())) {\r\n            this.victory();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 胜利处理\r\n     */\r\n    private victory() {\r\n        this.isVictory = true;\r\n        this.isGameOver = true;\r\n        this.audioManager?.playSound('victory');\r\n        this.storageManager?.completeLevel(this.currentLevelId);\r\n\r\n        // 显示胜利 UI\r\n        this.scheduleOnce(() => {\r\n            this.showResult(true);\r\n        }, 2);\r\n    }\r\n\r\n    /**\r\n     * 游戏失败处理\r\n     */\r\n    private gameOver() {\r\n        this.isGameOver = true;\r\n        this.audioManager?.playSound('fail');\r\n\r\n        this.scheduleOnce(() => {\r\n            this.showResult(false);\r\n        }, 1);\r\n    }\r\n\r\n    /**\r\n     * 显示结果\r\n     */\r\n    private showResult(isVictory: boolean) {\r\n        Logger.log(isVictory ? '胜利！' : '失败！');\r\n        \r\n        // 查找 GameSceneController 并调用其 showResult 方法\r\n        let sceneController: any = null;\r\n        \r\n        if (this.gameSceneController) {\r\n            sceneController = this.gameSceneController.getComponent('GameSceneController');\r\n        } else {\r\n            // 如果没有直接引用，尝试从父节点查找\r\n            let parent = this.node.parent;\r\n            while (parent) {\r\n                sceneController = parent.getComponent('GameSceneController');\r\n                if (sceneController) {\r\n                    break;\r\n                }\r\n                parent = parent.parent;\r\n            }\r\n        }\r\n        \r\n        if (sceneController && typeof sceneController.showResult === 'function') {\r\n            sceneController.showResult(isVictory, this.currentLevelId);\r\n        } else {\r\n            Logger.error('未找到 GameSceneController，无法显示结果');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新 UI\r\n     */\r\n    private updateUI() {\r\n        if (this.levelLabel) {\r\n            this.levelLabel.string = `关卡 ${this.currentLevelId}`;\r\n        }\r\n\r\n        // 更新红心\r\n        for (let i = 0; i < this.heartNodes.length; i++) {\r\n            if (this.heartNodes[i]) {\r\n                const sprite = this.heartNodes[i].getComponent(Sprite);\r\n                if (sprite) {\r\n                    sprite.color = i < this.failCount ? new Color(244, 67, 54, 255) : new Color(200, 200, 200, 255);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 等待指定时间\r\n     */\r\n    private wait(ms: number): Promise<void> {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    /**\r\n     * 十六进制颜色转 Color\r\n     */\r\n    private hexToColor(hex: string): Color {\r\n        const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n        if (result) {\r\n            return new Color(\r\n                parseInt(result[1], 16),\r\n                parseInt(result[2], 16),\r\n                parseInt(result[3], 16),\r\n                255\r\n            );\r\n        }\r\n        return new Color(255, 255, 255, 255);\r\n    }\r\n\r\n    /**\r\n     * 重新开始当前关卡\r\n     */\r\n    public restartLevel() {\r\n        this.initLevel(this.currentLevelId);\r\n    }\r\n\r\n    /**\r\n     * 返回主菜单\r\n     */\r\n    public returnToMenu() {\r\n        director.loadScene('LaunchScene');\r\n    }\r\n\r\n    /**\r\n     * 进入下一关\r\n     */\r\n    public nextLevel() {\r\n        const nextLevelId = this.currentLevelId + 1;\r\n        if (this.storageManager?.isLevelUnlocked(nextLevelId)) {\r\n            this.initLevel(nextLevelId);\r\n        } else {\r\n            this.returnToMenu();\r\n        }\r\n    }\r\n}\r\n\r\n"]}