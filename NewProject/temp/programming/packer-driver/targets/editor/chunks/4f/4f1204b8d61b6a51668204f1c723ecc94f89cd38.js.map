{"version":3,"sources":["file:///G:/escapeworm/NewProject/assets/scripts/ui/GameSceneController.ts"],"names":["_decorator","Component","Node","Label","Color","director","Graphics","GameController","StorageManager","ccclass","property","GameSceneController","gameController","storageManager","currentLevelId","onLoad","addComponent","init","getCurrentLevel","resultPanel","active","setupButtons","initGameController","gameArea","console","error","controllerNode","parent","node","levelLabel","heartNodes","initLevel","updateLevelLabel","showError","settingsButton","on","EventType","TOUCH_END","onSettingsClick","menuButton","onMenuClick","restartButton","onRestartClick","nextButton","onNextClick","string","log","loadScene","restartLevel","nextLevel","showResult","isVictory","resultLabel","color","message","updateHearts","failCount","i","length","graphics","getComponent","clear","fillColor","circle","fill"],"mappings":"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","sourcesContent":["/**\r\n * 游戏场景控制器\r\n * 用于管理 GameScene 中的 UI 和游戏逻辑初始化\r\n */\r\nimport { _decorator, Component, Node, Label, Sprite, Color, director, Button, \r\n    Graphics, UITransform, Vec3 } from 'cc';\r\nimport { GameController } from '../GameController';\r\nimport { StorageManager } from '../managers/StorageManager';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameSceneController')\r\nexport class GameSceneController extends Component {\r\n    @property(Node)\r\n    public gameArea: Node | null = null;\r\n\r\n    @property(Label)\r\n    public levelLabel: Label | null = null;\r\n\r\n    @property([Node])\r\n    public heartNodes: Node[] = [];\r\n\r\n    @property(Node)\r\n    public settingsButton: Node | null = null;\r\n\r\n    @property(Node)\r\n    public menuButton: Node | null = null;\r\n\r\n    @property(Node)\r\n    public restartButton: Node | null = null;\r\n\r\n    @property(Node)\r\n    public resultPanel: Node | null = null;\r\n\r\n    @property(Label)\r\n    public resultLabel: Label | null = null;\r\n\r\n    @property(Node)\r\n    public nextButton: Node | null = null;\r\n\r\n    private gameController: GameController | null = null;\r\n    private storageManager: StorageManager | null = null;\r\n    private currentLevelId: number = 1;\r\n\r\n    protected onLoad() {\r\n        // 初始化存储管理器获取当前关卡\r\n        this.storageManager = this.addComponent(StorageManager);\r\n        this.storageManager.init();\r\n        this.currentLevelId = this.storageManager.getCurrentLevel();\r\n\r\n        // 隐藏结果面板\r\n        if (this.resultPanel) {\r\n            this.resultPanel.active = false;\r\n        }\r\n\r\n        // 设置按钮事件\r\n        this.setupButtons();\r\n\r\n        // 初始化游戏控制器\r\n        this.initGameController();\r\n    }\r\n\r\n    /**\r\n     * 初始化游戏控制器\r\n     */\r\n    private async initGameController() {\r\n        if (!this.gameArea) {\r\n            console.error('游戏区域节点未设置');\r\n            return;\r\n        }\r\n\r\n        // 创建游戏控制器节点\r\n        const controllerNode = new Node('GameController');\r\n        controllerNode.parent = this.node;\r\n        this.gameController = controllerNode.addComponent(GameController);\r\n\r\n        // 设置游戏控制器的属性\r\n        this.gameController.gameArea = this.gameArea;\r\n        this.gameController.levelLabel = this.levelLabel;\r\n        this.gameController.heartNodes = this.heartNodes;\r\n\r\n        // 初始化关卡\r\n        try {\r\n            await this.gameController.initLevel(this.currentLevelId);\r\n            this.updateLevelLabel();\r\n        } catch (error) {\r\n            console.error('初始化关卡失败:', error);\r\n            this.showError('加载关卡失败');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 设置按钮事件\r\n     */\r\n    private setupButtons() {\r\n        if (this.settingsButton) {\r\n            this.settingsButton.on(Node.EventType.TOUCH_END, this.onSettingsClick, this);\r\n        }\r\n        if (this.menuButton) {\r\n            this.menuButton.on(Node.EventType.TOUCH_END, this.onMenuClick, this);\r\n        }\r\n        if (this.restartButton) {\r\n            this.restartButton.on(Node.EventType.TOUCH_END, this.onRestartClick, this);\r\n        }\r\n        if (this.nextButton) {\r\n            this.nextButton.on(Node.EventType.TOUCH_END, this.onNextClick, this);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新关卡标签\r\n     */\r\n    private updateLevelLabel() {\r\n        if (this.levelLabel) {\r\n            this.levelLabel.string = `关卡 ${this.currentLevelId}`;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 设置按钮点击\r\n     */\r\n    private onSettingsClick() {\r\n        console.log('打开设置');\r\n        // TODO: 实现设置面板\r\n    }\r\n\r\n    /**\r\n     * 返回菜单按钮点击\r\n     */\r\n    private onMenuClick() {\r\n        director.loadScene('LaunchScene');\r\n    }\r\n\r\n    /**\r\n     * 重新开始按钮点击\r\n     */\r\n    private onRestartClick() {\r\n        this.gameController?.restartLevel();\r\n    }\r\n\r\n    /**\r\n     * 下一关按钮点击\r\n     */\r\n    private onNextClick() {\r\n        this.gameController?.nextLevel();\r\n    }\r\n\r\n    /**\r\n     * 显示结果\r\n     */\r\n    public showResult(isVictory: boolean) {\r\n        if (this.resultPanel) {\r\n            this.resultPanel.active = true;\r\n        }\r\n\r\n        if (this.resultLabel) {\r\n            this.resultLabel.string = isVictory ? '胜利！' : '失败';\r\n            this.resultLabel.color = isVictory ? new Color(76, 175, 80, 255) : new Color(244, 67, 54, 255);\r\n        }\r\n\r\n        if (this.nextButton) {\r\n            this.nextButton.active = isVictory;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 显示错误信息\r\n     */\r\n    private showError(message: string) {\r\n        console.error(message);\r\n        // TODO: 显示错误提示 UI\r\n    }\r\n\r\n    /**\r\n     * 更新红心显示\r\n     */\r\n    public updateHearts(failCount: number) {\r\n        for (let i = 0; i < this.heartNodes.length; i++) {\r\n            if (this.heartNodes[i]) {\r\n                const graphics = this.heartNodes[i].getComponent(Graphics);\r\n                if (graphics) {\r\n                    graphics.clear();\r\n                    graphics.fillColor = i < failCount ? new Color(244, 67, 54, 255) : new Color(200, 200, 200, 255);\r\n                    graphics.circle(0, 0, 20);\r\n                    graphics.fill();\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n"]}