{"version":3,"sources":["file:///G:/escapeworm/NewProject/assets/scripts/GameController.ts"],"names":["_decorator","Component","Node","director","Vec2","Vec3","UITransform","Graphics","Color","Label","Sprite","SpriteFrame","resources","Input","Worm","PathFinder","CollisionDetector","LevelManager","StorageManager","AudioManager","EffectManager","ccclass","property","GameController","levelManager","storageManager","audioManager","effectManager","worms","wormNodes","matrix","escapePoints","failCount","isGameOver","isVictory","currentLevelId","isWormsAppearing","isInitialized","offsetX","offsetY","graphics","wormHeadSprite","wormBodySprite","wormTailSprite","gameAreaSetup","onLoad","addComponent","init","getSettings","loadWormImages","setupGameArea","gameArea","getComponent","on","EventType","TOUCH_END","onTouchEnd","console","log","loadSpriteFrame","e","warn","path","Promise","resolve","reject","load","err","spriteFrame","initLevel","levelId","forEach","n","destroy","updateUI","levelData","loadLevel","map","p","x","y","calculateRenderParams","wormConfig","wormNode","id","parent","worm","setVisibleSegmentCount","push","drawGrid","animateWormsAppearance","error","transform","areaWidth","width","areaHeight","height","cellSizeX","cellSizeY","cellSize","Math","min","gridWidth","gridHeight","clear","strokeColor","lineWidth","screenX","moveTo","lineTo","screenY","stroke","worldToScreen","screenToWorld","floor","segmentInterval","maxSegments","max","segments","length","segmentIndex","updateWormVisuals","wait","update","dt","i","hasEscaped","active","getInterpolatedSegments","visibleCount","visibleSegmentCount","renderWormSegments","currentCount","children","idx","segmentNode","isVisible","segment","screenPos","setPosition","radius","color","hexToColor","isHighlighted","fillColor","circle","fill","drawEyes","direction","eyeSize","eyeOffset","eyeX1","eyeY1","eyeX2","eyeY2","pupilSize","event","location","getUILocation","localPos","convertToNodeSpaceAR","clickedWorm","findWormAtPosition","isAnimating","handleWormClick","localX","localY","clickRadius","getAllSegments","segmentLocalX","segmentLocalY","dx","dy","distance","sqrt","playSound","obstacles","getObstacles","result","findPath","getHeadPosition","getLength","canEscape","moveWormToEscape","pathToObstacle","moveWormToObstacleAndBack","tryMoveWormOneStep","excludeWorm","isEscaping","moveDuration","nextPos","wormLikeArray","w","isEscaped","checkCollision","handleCollision","startMoveAnimation","markEscaped","createEscapeEffect","checkVictory","originalSegments","s","getDirectionVector","pos","lastPos","obstaclePos","flashWorm","reset","gameOver","headPos","isInBounds","setHighlighted","every","victory","completeLevel","scheduleOnce","showResult","levelLabel","string","heartNodes","sprite","ms","setTimeout","hex","exec","parseInt","restartLevel","returnToMenu","loadScene","nextLevel","nextLevelId","isLevelUnlocked"],"mappings":"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","sourcesContent":["/**\r\n * 游戏主控制器\r\n */\r\nimport { _decorator, Component, Node, director, Vec2, Vec3, instantiate, Prefab, \r\n    UITransform, Graphics, Color, Label, Sprite, SpriteFrame, resources, Canvas,\r\n    EventTouch, view, screen, Size, input, Input } from 'cc';\r\nimport { Worm, WormConfig } from './entities/Worm';\r\nimport { PathFinder } from './utils/PathFinder';\r\nimport { CollisionDetector, WormLike } from './utils/CollisionDetector';\r\nimport { LevelManager, LevelData } from './managers/LevelManager';\r\nimport { StorageManager } from './managers/StorageManager';\r\nimport { AudioManager } from './managers/AudioManager';\r\nimport { EffectManager } from './managers/EffectManager';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameController')\r\nexport class GameController extends Component {\r\n    @property(Node)\r\n    public gameArea: Node | null = null;\r\n\r\n    @property(Node)\r\n    public uiLayer: Node | null = null;\r\n\r\n    @property(Label)\r\n    public levelLabel: Label | null = null;\r\n\r\n    @property([Node])\r\n    public heartNodes: Node[] = [];\r\n\r\n    @property\r\n    public cellSize: number = 60;\r\n\r\n    // 管理器\r\n    private levelManager: LevelManager | null = null;\r\n    private storageManager: StorageManager | null = null;\r\n    private audioManager: AudioManager | null = null;\r\n    private effectManager: EffectManager | null = null;\r\n\r\n    // 游戏状态\r\n    private worms: Worm[] = [];\r\n    private wormNodes: Node[] = [];\r\n    private matrix: { width: number; height: number } | null = null;\r\n    private escapePoints: Vec2[] = [];\r\n    private failCount: number = 3;\r\n    private isGameOver: boolean = false;\r\n    private isVictory: boolean = false;\r\n    private currentLevelId: number = 1;\r\n    private isWormsAppearing: boolean = false;\r\n    private isInitialized: boolean = false;\r\n\r\n    // 渲染相关\r\n    private offsetX: number = 0;\r\n    private offsetY: number = 0;\r\n    private graphics: Graphics | null = null;\r\n\r\n    // 图片资源\r\n    private wormHeadSprite: SpriteFrame | null = null;\r\n    private wormBodySprite: SpriteFrame | null = null;\r\n    private wormTailSprite: SpriteFrame | null = null;\r\n\r\n    protected onLoad() {\r\n        // 初始化管理器\r\n        this.levelManager = this.addComponent(LevelManager);\r\n        this.storageManager = this.addComponent(StorageManager);\r\n        this.audioManager = this.addComponent(AudioManager);\r\n        this.effectManager = this.addComponent(EffectManager);\r\n\r\n        this.storageManager.init();\r\n        this.audioManager.init(this.storageManager.getSettings());\r\n\r\n        // 加载蠕虫图片资源\r\n        this.loadWormImages();\r\n    }\r\n    \r\n    private gameAreaSetup: boolean = false;\r\n    \r\n    /**\r\n     * 设置游戏区域并注册事件（在 gameArea 被外部设置后调用）\r\n     */\r\n    private setupGameArea() {\r\n        if (!this.gameArea || this.gameAreaSetup) return;\r\n        \r\n        // 创建 Graphics 组件用于绘制网格\r\n        this.graphics = this.gameArea.getComponent(Graphics);\r\n        if (!this.graphics) {\r\n            // 确保先有 UITransform\r\n            if (!this.gameArea.getComponent(UITransform)) {\r\n                this.gameArea.addComponent(UITransform);\r\n            }\r\n            this.graphics = this.gameArea.addComponent(Graphics);\r\n        }\r\n\r\n        // 注册触摸事件\r\n        this.gameArea.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        console.log('触摸事件已注册到 gameArea');\r\n        \r\n        this.gameAreaSetup = true;\r\n    }\r\n\r\n    /**\r\n     * 加载蠕虫图片资源\r\n     */\r\n    private async loadWormImages() {\r\n        try {\r\n            this.wormHeadSprite = await this.loadSpriteFrame('images/worm_head');\r\n            this.wormBodySprite = await this.loadSpriteFrame('images/worm_body');\r\n            this.wormTailSprite = await this.loadSpriteFrame('images/worm_tail');\r\n        } catch (e) {\r\n            console.warn('蠕虫图片资源加载失败，将使用默认绘制方式');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 加载 SpriteFrame\r\n     */\r\n    private loadSpriteFrame(path: string): Promise<SpriteFrame> {\r\n        return new Promise((resolve, reject) => {\r\n            resources.load(path + '/spriteFrame', SpriteFrame, (err, spriteFrame) => {\r\n                if (err) {\r\n                    reject(err);\r\n                } else {\r\n                    resolve(spriteFrame);\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 初始化游戏关卡\r\n     */\r\n    public async initLevel(levelId: number) {\r\n        // 暂停更新，防止在初始化过程中触发渲染\r\n        this.isInitialized = false;\r\n        \r\n        // 设置游戏区域（注册触摸事件）\r\n        this.setupGameArea();\r\n        \r\n        this.currentLevelId = levelId;\r\n        this.failCount = 3;\r\n        this.isGameOver = false;\r\n        this.isVictory = false;\r\n        this.worms = [];\r\n        this.wormNodes.forEach(n => n.destroy());\r\n        this.wormNodes = [];\r\n        this.escapePoints = [];\r\n\r\n        // 更新 UI\r\n        this.updateUI();\r\n\r\n        try {\r\n            // 加载关卡数据\r\n            const levelData = await this.levelManager!.loadLevel(levelId);\r\n            this.matrix = levelData.matrix;\r\n            this.escapePoints = levelData.escapePoints.map(p => new Vec2(p.x, p.y));\r\n\r\n            // 计算渲染参数\r\n            this.calculateRenderParams();\r\n\r\n            // 创建蠕虫对象\r\n            for (const wormConfig of levelData.worms) {\r\n                const wormNode = new Node(`Worm_${wormConfig.id}`);\r\n                wormNode.parent = this.gameArea;\r\n                const worm = wormNode.addComponent(Worm);\r\n                worm.init(wormConfig);\r\n                worm.setVisibleSegmentCount(0);\r\n                this.worms.push(worm);\r\n                this.wormNodes.push(wormNode);\r\n            }\r\n\r\n            // 绘制网格\r\n            this.drawGrid();\r\n\r\n            // 逐个显示蠕虫\r\n            await this.animateWormsAppearance();\r\n            \r\n            // 初始化完成\r\n            this.isInitialized = true;\r\n\r\n        } catch (error) {\r\n            console.error('初始化游戏场景失败:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 计算渲染参数\r\n     */\r\n    private calculateRenderParams() {\r\n        if (!this.matrix || !this.gameArea) return;\r\n\r\n        const transform = this.gameArea.getComponent(UITransform);\r\n        if (!transform) return;\r\n\r\n        const areaWidth = transform.width;\r\n        const areaHeight = transform.height;\r\n\r\n        // 计算合适的 cellSize\r\n        const cellSizeX = areaWidth / this.matrix.width;\r\n        const cellSizeY = areaHeight / this.matrix.height;\r\n        this.cellSize = Math.min(cellSizeX, cellSizeY) * 0.9;\r\n\r\n        // 计算偏移量使网格居中\r\n        const gridWidth = this.matrix.width * this.cellSize;\r\n        const gridHeight = this.matrix.height * this.cellSize;\r\n        this.offsetX = (areaWidth - gridWidth) / 2 - areaWidth / 2;\r\n        this.offsetY = (areaHeight - gridHeight) / 2 - areaHeight / 2;\r\n    }\r\n\r\n    /**\r\n     * 绘制网格\r\n     */\r\n    private drawGrid() {\r\n        if (!this.graphics || !this.matrix) return;\r\n\r\n        this.graphics.clear();\r\n        this.graphics.strokeColor = new Color(224, 224, 224, 255);\r\n        this.graphics.lineWidth = 1;\r\n\r\n        // 绘制垂直网格线\r\n        for (let x = 0; x <= this.matrix.width; x++) {\r\n            const screenX = this.offsetX + x * this.cellSize;\r\n            this.graphics.moveTo(screenX, this.offsetY);\r\n            this.graphics.lineTo(screenX, this.offsetY + this.matrix.height * this.cellSize);\r\n        }\r\n\r\n        // 绘制水平网格线\r\n        for (let y = 0; y <= this.matrix.height; y++) {\r\n            const screenY = this.offsetY + y * this.cellSize;\r\n            this.graphics.moveTo(this.offsetX, screenY);\r\n            this.graphics.lineTo(this.offsetX + this.matrix.width * this.cellSize, screenY);\r\n        }\r\n\r\n        this.graphics.stroke();\r\n    }\r\n\r\n    /**\r\n     * 世界坐标转屏幕坐标\r\n     */\r\n    private worldToScreen(x: number, y: number): Vec3 {\r\n        return new Vec3(\r\n            this.offsetX + (x + 0.5) * this.cellSize,\r\n            -(this.offsetY + (y + 0.5) * this.cellSize),\r\n            0\r\n        );\r\n    }\r\n\r\n    /**\r\n     * 屏幕坐标转世界坐标\r\n     */\r\n    private screenToWorld(screenX: number, screenY: number): Vec2 {\r\n        const x = Math.floor((screenX - this.offsetX) / this.cellSize);\r\n        const y = Math.floor((-screenY - this.offsetY) / this.cellSize);\r\n        return new Vec2(x, y);\r\n    }\r\n\r\n    /**\r\n     * 动画显示蠕虫\r\n     */\r\n    private async animateWormsAppearance() {\r\n        this.isWormsAppearing = true;\r\n        const segmentInterval = 50;\r\n\r\n        let maxSegments = 0;\r\n        for (const worm of this.worms) {\r\n            maxSegments = Math.max(maxSegments, worm.segments.length);\r\n        }\r\n\r\n        for (let segmentIndex = 1; segmentIndex <= maxSegments; segmentIndex++) {\r\n            for (const worm of this.worms) {\r\n                if (segmentIndex <= worm.segments.length) {\r\n                    worm.setVisibleSegmentCount(segmentIndex);\r\n                }\r\n            }\r\n            this.updateWormVisuals();\r\n            await this.wait(segmentInterval);\r\n        }\r\n\r\n        for (const worm of this.worms) {\r\n            worm.setVisibleSegmentCount(worm.segments.length);\r\n        }\r\n\r\n        this.isWormsAppearing = false;\r\n    }\r\n\r\n    /**\r\n     * 更新蠕虫可视化\r\n     */\r\n    protected update(dt: number) {\r\n        if (this.isInitialized && this.worms.length > 0) {\r\n            this.updateWormVisuals();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新蠕虫可视化\r\n     */\r\n    private updateWormVisuals() {\r\n        for (let i = 0; i < this.worms.length; i++) {\r\n            const worm = this.worms[i];\r\n            const wormNode = this.wormNodes[i];\r\n\r\n            if (worm.hasEscaped()) {\r\n                wormNode.active = false;\r\n                continue;\r\n            }\r\n\r\n            wormNode.active = true;\r\n\r\n            // 获取插值后的段位置\r\n            const segments = worm.getInterpolatedSegments();\r\n            const visibleCount = worm.visibleSegmentCount;\r\n\r\n            // 更新每个段的位置\r\n            this.renderWormSegments(wormNode, worm, segments, visibleCount);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 渲染蠕虫段\r\n     */\r\n    private renderWormSegments(wormNode: Node, worm: Worm, segments: Vec2[], visibleCount: number) {\r\n        // 确保有足够的子节点\r\n        const currentCount = wormNode.children.length;\r\n        for (let idx = currentCount; idx < segments.length; idx++) {\r\n            const segmentNode = new Node(`Segment_${idx}`);\r\n            \r\n            // 先添加 UITransform\r\n            const transform = segmentNode.addComponent(UITransform);\r\n            // 再添加 Graphics 组件用于绘制\r\n            const graphics = segmentNode.addComponent(Graphics);\r\n            \r\n            // 最后设置 parent，避免在设置 parent 时触发额外逻辑\r\n            segmentNode.parent = wormNode;\r\n        }\r\n\r\n        // 更新每个段\r\n        for (let i = 0; i < segments.length; i++) {\r\n            const segmentNode = wormNode.children[i];\r\n            const isVisible = i >= (segments.length - visibleCount);\r\n            segmentNode.active = isVisible;\r\n\r\n            if (!isVisible) continue;\r\n\r\n            const segment = segments[i];\r\n            const screenPos = this.worldToScreen(segment.x, segment.y);\r\n            segmentNode.setPosition(screenPos);\r\n\r\n            // 绘制段\r\n            const graphics = segmentNode.getComponent(Graphics);\r\n            if (graphics) {\r\n                graphics.clear();\r\n                \r\n                const radius = this.cellSize * 0.4;\r\n                const color = this.hexToColor(worm.color);\r\n                \r\n                if (worm.isHighlighted) {\r\n                    graphics.fillColor = new Color(255, 100, 100, 255);\r\n                } else {\r\n                    graphics.fillColor = color;\r\n                }\r\n                \r\n                graphics.circle(0, 0, radius);\r\n                graphics.fill();\r\n\r\n                // 绘制眼睛（头部）\r\n                if (i === 0) {\r\n                    this.drawEyes(graphics, worm.direction, radius);\r\n                }\r\n            }\r\n        }\r\n\r\n        // 隐藏多余的节点\r\n        for (let i = segments.length; i < wormNode.children.length; i++) {\r\n            wormNode.children[i].active = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 绘制眼睛\r\n     */\r\n    private drawEyes(graphics: Graphics, direction: string, radius: number) {\r\n        graphics.fillColor = new Color(255, 255, 255, 255);\r\n        const eyeSize = radius * 0.35;\r\n        const eyeOffset = radius * 0.35;\r\n\r\n        let eyeX1: number, eyeY1: number, eyeX2: number, eyeY2: number;\r\n\r\n        switch (direction) {\r\n            case 'left':\r\n                eyeX1 = -eyeOffset; eyeY1 = -eyeOffset;\r\n                eyeX2 = -eyeOffset; eyeY2 = eyeOffset;\r\n                break;\r\n            case 'right':\r\n                eyeX1 = eyeOffset; eyeY1 = -eyeOffset;\r\n                eyeX2 = eyeOffset; eyeY2 = eyeOffset;\r\n                break;\r\n            case 'up':\r\n                eyeX1 = -eyeOffset; eyeY1 = eyeOffset;\r\n                eyeX2 = eyeOffset; eyeY2 = eyeOffset;\r\n                break;\r\n            case 'down':\r\n            default:\r\n                eyeX1 = -eyeOffset; eyeY1 = -eyeOffset;\r\n                eyeX2 = eyeOffset; eyeY2 = -eyeOffset;\r\n                break;\r\n        }\r\n\r\n        // 白色眼睛\r\n        graphics.circle(eyeX1, eyeY1, eyeSize);\r\n        graphics.fill();\r\n        graphics.circle(eyeX2, eyeY2, eyeSize);\r\n        graphics.fill();\r\n\r\n        // 黑色眼珠\r\n        graphics.fillColor = new Color(0, 0, 0, 255);\r\n        const pupilSize = eyeSize * 0.5;\r\n        graphics.circle(eyeX1, eyeY1, pupilSize);\r\n        graphics.fill();\r\n        graphics.circle(eyeX2, eyeY2, pupilSize);\r\n        graphics.fill();\r\n    }\r\n\r\n    /**\r\n     * 处理触摸事件\r\n     */\r\n    private onTouchEnd(event: EventTouch) {\r\n        if (this.isGameOver || this.isVictory || this.isWormsAppearing) {\r\n            console.log('触摸被忽略: isGameOver=', this.isGameOver, 'isVictory=', this.isVictory, 'isWormsAppearing=', this.isWormsAppearing);\r\n            return;\r\n        }\r\n\r\n        const location = event.getUILocation();\r\n        const transform = this.gameArea?.getComponent(UITransform);\r\n        if (!transform) {\r\n            console.log('transform 不存在');\r\n            return;\r\n        }\r\n\r\n        // 转换为节点本地坐标\r\n        const localPos = transform.convertToNodeSpaceAR(new Vec3(location.x, location.y, 0));\r\n        console.log('触摸位置: UI=', location.x, location.y, ' Local=', localPos.x, localPos.y);\r\n        \r\n        // 查找点击的蠕虫\r\n        const clickedWorm = this.findWormAtPosition(localPos.x, localPos.y);\r\n        if (clickedWorm) {\r\n            console.log('找到蠕虫:', clickedWorm.id, 'escaped=', clickedWorm.hasEscaped(), 'animating=', clickedWorm.isAnimating);\r\n            if (!clickedWorm.hasEscaped() && !clickedWorm.isAnimating) {\r\n                this.handleWormClick(clickedWorm);\r\n            }\r\n        } else {\r\n            console.log('没有找到蠕虫');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 查找点击位置的蠕虫\r\n     */\r\n    private findWormAtPosition(localX: number, localY: number): Worm | null {\r\n        const clickRadius = this.cellSize * 0.6;\r\n\r\n        for (const worm of this.worms) {\r\n            if (worm.hasEscaped()) continue;\r\n\r\n            for (const segment of worm.getAllSegments()) {\r\n                // 计算蠕虫段在本地坐标系中的位置\r\n                const segmentLocalX = this.offsetX + (segment.x + 0.5) * this.cellSize;\r\n                const segmentLocalY = -(this.offsetY + (segment.y + 0.5) * this.cellSize);\r\n                \r\n                const dx = localX - segmentLocalX;\r\n                const dy = localY - segmentLocalY;\r\n                const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n                if (distance <= clickRadius) {\r\n                    return worm;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * 处理蠕虫点击\r\n     */\r\n    private async handleWormClick(worm: Worm) {\r\n        this.audioManager?.playSound('click');\r\n\r\n        // 获取障碍物\r\n        const obstacles = this.getObstacles(worm);\r\n\r\n        // 查找逃脱路径\r\n        const result = PathFinder.findPath(\r\n            worm.getHeadPosition(),\r\n            worm.direction,\r\n            worm.getLength(),\r\n            worm.getAllSegments(),\r\n            this.matrix!.width,\r\n            this.matrix!.height,\r\n            obstacles,\r\n            this.escapePoints\r\n        );\r\n\r\n        if (result.canEscape && result.path.length > 0) {\r\n            await this.moveWormToEscape(worm, result.path);\r\n        } else if (!result.canEscape && result.pathToObstacle) {\r\n            await this.moveWormToObstacleAndBack(worm, result.pathToObstacle);\r\n        } else {\r\n            await this.tryMoveWormOneStep(worm);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 获取障碍物\r\n     */\r\n    private getObstacles(excludeWorm: Worm): Vec2[] {\r\n        const obstacles: Vec2[] = [];\r\n        for (const worm of this.worms) {\r\n            if (worm.id === excludeWorm.id || worm.hasEscaped() || worm.isEscaping || worm.isAnimating) {\r\n                continue;\r\n            }\r\n            obstacles.push(...worm.getAllSegments());\r\n        }\r\n        return obstacles;\r\n    }\r\n\r\n    /**\r\n     * 移动蠕虫逃脱\r\n     */\r\n    private async moveWormToEscape(worm: Worm, path: Vec2[]) {\r\n        worm.isEscaping = true;\r\n        const moveDuration = 80;\r\n\r\n        for (const nextPos of path) {\r\n            // 检查碰撞\r\n            const wormLikeArray = this.worms.map(w => ({\r\n                id: w.id,\r\n                segments: w.segments,\r\n                direction: w.direction,\r\n                isEscaped: w.isEscaped,\r\n                isEscaping: w.isEscaping,\r\n                isAnimating: w.isAnimating\r\n            }));\r\n\r\n            if (CollisionDetector.checkCollision({\r\n                id: worm.id,\r\n                segments: worm.segments,\r\n                direction: worm.direction,\r\n                isEscaped: worm.isEscaped,\r\n                isEscaping: worm.isEscaping,\r\n                isAnimating: worm.isAnimating\r\n            }, nextPos, wormLikeArray)) {\r\n                await this.handleCollision(worm);\r\n                return;\r\n            }\r\n\r\n            await worm.startMoveAnimation(nextPos, moveDuration);\r\n            this.audioManager?.playSound('move');\r\n        }\r\n\r\n        // 标记为逃脱\r\n        worm.isEscaping = false;\r\n        worm.markEscaped();\r\n        this.audioManager?.playSound('escape');\r\n        this.effectManager?.createEscapeEffect(\r\n            this.worldToScreen(worm.getHeadPosition().x, worm.getHeadPosition().y),\r\n            worm.color\r\n        );\r\n\r\n        this.checkVictory();\r\n    }\r\n\r\n    /**\r\n     * 移动蠕虫到障碍物并返回\r\n     */\r\n    private async moveWormToObstacleAndBack(worm: Worm, pathToObstacle: Vec2[]) {\r\n        const originalSegments = worm.segments.map(s => new Vec2(s.x, s.y));\r\n        const moveDuration = 60;\r\n        const direction = PathFinder.getDirectionVector(worm.direction);\r\n\r\n        // 移动到障碍物位置\r\n        for (const pos of pathToObstacle) {\r\n            await worm.startMoveAnimation(pos, moveDuration);\r\n        }\r\n\r\n        // 再移动一步到障碍物\r\n        const lastPos = pathToObstacle.length > 0 \r\n            ? pathToObstacle[pathToObstacle.length - 1] \r\n            : worm.getHeadPosition();\r\n        const obstaclePos = new Vec2(lastPos.x + direction.x, lastPos.y + direction.y);\r\n        await worm.startMoveAnimation(obstaclePos, moveDuration);\r\n\r\n        this.audioManager?.playSound('collision');\r\n\r\n        // 高亮闪烁\r\n        await this.flashWorm(worm);\r\n\r\n        // 返回原位\r\n        worm.reset();\r\n\r\n        this.failCount--;\r\n        this.updateUI();\r\n\r\n        if (this.failCount <= 0) {\r\n            this.gameOver();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 尝试移动蠕虫一步\r\n     */\r\n    private async tryMoveWormOneStep(worm: Worm) {\r\n        const headPos = worm.getHeadPosition();\r\n        const direction = PathFinder.getDirectionVector(worm.direction);\r\n        const nextPos = new Vec2(headPos.x + direction.x, headPos.y + direction.y);\r\n\r\n        // 检查边界\r\n        if (!CollisionDetector.isInBounds(nextPos, this.matrix!.width, this.matrix!.height)) {\r\n            // 可以逃脱\r\n            await worm.startMoveAnimation(nextPos, 80);\r\n            worm.markEscaped();\r\n            this.audioManager?.playSound('escape');\r\n            this.checkVictory();\r\n            return;\r\n        }\r\n\r\n        // 检查碰撞\r\n        const wormLikeArray = this.worms.map(w => ({\r\n            id: w.id,\r\n            segments: w.segments,\r\n            direction: w.direction,\r\n            isEscaped: w.isEscaped,\r\n            isEscaping: w.isEscaping,\r\n            isAnimating: w.isAnimating\r\n        }));\r\n\r\n        if (CollisionDetector.checkCollision({\r\n            id: worm.id,\r\n            segments: worm.segments,\r\n            direction: worm.direction,\r\n            isEscaped: worm.isEscaped,\r\n            isEscaping: worm.isEscaping,\r\n            isAnimating: worm.isAnimating\r\n        }, nextPos, wormLikeArray)) {\r\n            await this.handleCollision(worm);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理碰撞\r\n     */\r\n    private async handleCollision(worm: Worm) {\r\n        this.audioManager?.playSound('collision');\r\n        await this.flashWorm(worm);\r\n        worm.reset();\r\n        worm.isEscaping = false;\r\n\r\n        this.failCount--;\r\n        this.updateUI();\r\n\r\n        if (this.failCount <= 0) {\r\n            this.gameOver();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 蠕虫闪烁效果\r\n     */\r\n    private async flashWorm(worm: Worm): Promise<void> {\r\n        for (let i = 0; i < 6; i++) {\r\n            worm.setHighlighted(i % 2 === 0);\r\n            await this.wait(100);\r\n        }\r\n        worm.setHighlighted(false);\r\n    }\r\n\r\n    /**\r\n     * 检查胜利\r\n     */\r\n    private checkVictory() {\r\n        if (this.worms.every(worm => worm.hasEscaped())) {\r\n            this.victory();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 胜利处理\r\n     */\r\n    private victory() {\r\n        this.isVictory = true;\r\n        this.isGameOver = true;\r\n        this.audioManager?.playSound('victory');\r\n        this.storageManager?.completeLevel(this.currentLevelId);\r\n\r\n        // 显示胜利 UI\r\n        this.scheduleOnce(() => {\r\n            this.showResult(true);\r\n        }, 2);\r\n    }\r\n\r\n    /**\r\n     * 游戏失败处理\r\n     */\r\n    private gameOver() {\r\n        this.isGameOver = true;\r\n        this.audioManager?.playSound('fail');\r\n\r\n        this.scheduleOnce(() => {\r\n            this.showResult(false);\r\n        }, 1);\r\n    }\r\n\r\n    /**\r\n     * 显示结果\r\n     */\r\n    private showResult(isVictory: boolean) {\r\n        // 这里可以切换到结果场景或显示结果 UI\r\n        console.log(isVictory ? '胜利！' : '失败！');\r\n        // director.loadScene('ResultScene');\r\n    }\r\n\r\n    /**\r\n     * 更新 UI\r\n     */\r\n    private updateUI() {\r\n        if (this.levelLabel) {\r\n            this.levelLabel.string = `关卡 ${this.currentLevelId}`;\r\n        }\r\n\r\n        // 更新红心\r\n        for (let i = 0; i < this.heartNodes.length; i++) {\r\n            if (this.heartNodes[i]) {\r\n                const sprite = this.heartNodes[i].getComponent(Sprite);\r\n                if (sprite) {\r\n                    sprite.color = i < this.failCount ? new Color(244, 67, 54, 255) : new Color(200, 200, 200, 255);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 等待指定时间\r\n     */\r\n    private wait(ms: number): Promise<void> {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    /**\r\n     * 十六进制颜色转 Color\r\n     */\r\n    private hexToColor(hex: string): Color {\r\n        const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n        if (result) {\r\n            return new Color(\r\n                parseInt(result[1], 16),\r\n                parseInt(result[2], 16),\r\n                parseInt(result[3], 16),\r\n                255\r\n            );\r\n        }\r\n        return new Color(255, 255, 255, 255);\r\n    }\r\n\r\n    /**\r\n     * 重新开始当前关卡\r\n     */\r\n    public restartLevel() {\r\n        this.initLevel(this.currentLevelId);\r\n    }\r\n\r\n    /**\r\n     * 返回主菜单\r\n     */\r\n    public returnToMenu() {\r\n        director.loadScene('LaunchScene');\r\n    }\r\n\r\n    /**\r\n     * 进入下一关\r\n     */\r\n    public nextLevel() {\r\n        const nextLevelId = this.currentLevelId + 1;\r\n        if (this.storageManager?.isLevelUnlocked(nextLevelId)) {\r\n            this.initLevel(nextLevelId);\r\n        } else {\r\n            this.returnToMenu();\r\n        }\r\n    }\r\n}\r\n\r\n"]}