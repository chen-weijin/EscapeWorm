{"version":3,"sources":["file:///G:/escapeworm/NewProject/assets/scripts/managers/LevelManager.ts"],"names":["_decorator","Component","resources","JsonAsset","Logger","ccclass","property","LevelManager","currentLevel","currentLevelData","levelsPath","loadLevel","levelId","Promise","resolve","reject","filePath","load","err","jsonAsset","error","Error","message","levelData","json","validateLevelData","e","matrix","worms","escapePoints","width","height","Array","isArray","length","worm","id","segments","direction","color","segment","x","y","getCurrentLevelData","getCurrentLevelId","getTotalLevels"],"mappings":";;;;;;;;;;;;;;;;AAGSA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,S,OAAAA,S;;AAClCC,MAAAA,M,iBAAAA,M;;;;;;AAJT;AACA;AACA;;;;;OAGM;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBN,U;;8BAkBjBO,Y,WADZF,OAAO,CAAC,cAAD,C,gBAAR,MACaE,YADb,SACkCN,SADlC,CAC4C;AAAA;AAAA;AAAA,eAChCO,YADgC,GACF,IADE;AAAA,eAEhCC,gBAFgC,GAEK,IAFL;AAAA,eAGhCC,UAHgC,GAGX,SAHW;AAAA;;AAKxC;AACJ;AACA;AACWC,QAAAA,SAAS,CAACC,OAAD,EAAsC;AAClD,iBAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACpC,kBAAMC,QAAQ,GAAI,GAAE,KAAKN,UAAW,QAAOE,OAAQ,EAAnD;AAEAV,YAAAA,SAAS,CAACe,IAAV,CAAeD,QAAf,EAAyBb,SAAzB,EAAoC,CAACe,GAAD,EAAMC,SAAN,KAAoB;AACpD,kBAAID,GAAJ,EAAS;AACL;AAAA;AAAA,sCAAOE,KAAP,CAAa,SAAb,EAAwBF,GAAxB;AACAH,gBAAAA,MAAM,CAAC,IAAIM,KAAJ,CAAU,aAAaH,GAAG,CAACI,OAA3B,CAAD,CAAN;AACA;AACH;;AAED,kBAAI;AACA,sBAAMC,SAAS,GAAGJ,SAAS,CAACK,IAA5B;;AAEA,oBAAI,KAAKC,iBAAL,CAAuBF,SAAvB,CAAJ,EAAuC;AACnC,uBAAKf,YAAL,GAAoBI,OAApB;AACA,uBAAKH,gBAAL,GAAwBc,SAAxB;AACAT,kBAAAA,OAAO,CAACS,SAAD,CAAP;AACH,iBAJD,MAIO;AACH;AAAA;AAAA,wCAAOH,KAAP,CAAa,WAAb,EAA0BR,OAA1B;AACAG,kBAAAA,MAAM,CAAC,IAAIM,KAAJ,CAAU,UAAV,CAAD,CAAN;AACH;AACJ,eAXD,CAWE,OAAOK,CAAP,EAAU;AACR;AAAA;AAAA,sCAAON,KAAP,CAAa,WAAb,EAA0BM,CAA1B;AACAX,gBAAAA,MAAM,CAAC,IAAIM,KAAJ,CAAU,UAAV,CAAD,CAAN;AACH;AACJ,aAtBD;AAuBH,WA1BM,CAAP;AA2BH;AAED;AACJ;AACA;;;AACYI,QAAAA,iBAAiB,CAACF,SAAD,EAA0B;AAC/C,cAAI,CAACA,SAAS,CAACX,OAAX,IAAsB,CAACW,SAAS,CAACI,MAAjC,IAA2C,CAACJ,SAAS,CAACK,KAAtD,IAA+D,CAACL,SAAS,CAACM,YAA9E,EAA4F;AACxF,mBAAO,KAAP;AACH;;AAED,cAAI,CAACN,SAAS,CAACI,MAAV,CAAiBG,KAAlB,IAA2B,CAACP,SAAS,CAACI,MAAV,CAAiBI,MAAjD,EAAyD;AACrD,mBAAO,KAAP;AACH;;AAED,cAAI,CAACC,KAAK,CAACC,OAAN,CAAcV,SAAS,CAACK,KAAxB,CAAD,IAAmCL,SAAS,CAACK,KAAV,CAAgBM,MAAhB,KAA2B,CAAlE,EAAqE;AACjE,mBAAO,KAAP;AACH;;AAED,cAAI,CAACF,KAAK,CAACC,OAAN,CAAcV,SAAS,CAACM,YAAxB,CAAD,IAA0CN,SAAS,CAACM,YAAV,CAAuBK,MAAvB,KAAkC,CAAhF,EAAmF;AAC/E,mBAAO,KAAP;AACH,WAf8C,CAiB/C;;;AACA,eAAK,MAAMC,IAAX,IAAmBZ,SAAS,CAACK,KAA7B,EAAoC;AAChC,gBAAI,CAACO,IAAI,CAACC,EAAN,IAAY,CAACD,IAAI,CAACE,QAAlB,IAA8B,CAACF,IAAI,CAACG,SAApC,IAAiD,CAACH,IAAI,CAACI,KAA3D,EAAkE;AAC9D,qBAAO,KAAP;AACH;;AACD,gBAAI,CAACP,KAAK,CAACC,OAAN,CAAcE,IAAI,CAACE,QAAnB,CAAD,IAAiCF,IAAI,CAACE,QAAL,CAAcH,MAAd,GAAuB,CAA5D,EAA+D;AAC3D,qBAAO,KAAP;AACH,aAN+B,CAOhC;;;AACA,iBAAK,MAAMM,OAAX,IAAsBL,IAAI,CAACE,QAA3B,EAAqC;AACjC,kBAAIG,OAAO,CAACC,CAAR,GAAY,CAAZ,IAAiBD,OAAO,CAACC,CAAR,IAAalB,SAAS,CAACI,MAAV,CAAiBG,KAA/C,IACAU,OAAO,CAACE,CAAR,GAAY,CADZ,IACiBF,OAAO,CAACE,CAAR,IAAanB,SAAS,CAACI,MAAV,CAAiBI,MADnD,EAC2D;AACvD,uBAAO,KAAP;AACH;AACJ;AACJ;;AAED,iBAAO,IAAP;AACH;AAED;AACJ;AACA;;;AACWY,QAAAA,mBAAmB,GAAqB;AAC3C,iBAAO,KAAKlC,gBAAZ;AACH;AAED;AACJ;AACA;;;AACWmC,QAAAA,iBAAiB,GAAkB;AACtC,iBAAO,KAAKpC,YAAZ;AACH;AAED;AACJ;AACA;;;AACWqC,QAAAA,cAAc,GAAW;AAC5B,iBAAO,CAAP,CAD4B,CAClB;AACb;;AAjGuC,O","sourcesContent":["/**\r\n * 关卡管理器\r\n */\r\nimport { _decorator, Component, resources, JsonAsset } from 'cc';\r\nimport { Logger } from '../utils/Logger';\r\nconst { ccclass, property } = _decorator;\r\n\r\nexport interface LevelData {\r\n    levelId: number;\r\n    matrix: {\r\n        width: number;\r\n        height: number;\r\n    };\r\n    escapePoints: { x: number; y: number }[];\r\n    worms: {\r\n        id: number;\r\n        segments: { x: number; y: number }[];\r\n        direction: string;\r\n        color: string;\r\n    }[];\r\n}\r\n\r\n@ccclass('LevelManager')\r\nexport class LevelManager extends Component {\r\n    private currentLevel: number | null = null;\r\n    private currentLevelData: LevelData | null = null;\r\n    private levelsPath: string = 'levels/';\r\n\r\n    /**\r\n     * 加载关卡配置\r\n     */\r\n    public loadLevel(levelId: number): Promise<LevelData> {\r\n        return new Promise((resolve, reject) => {\r\n            const filePath = `${this.levelsPath}level${levelId}`;\r\n\r\n            resources.load(filePath, JsonAsset, (err, jsonAsset) => {\r\n                if (err) {\r\n                    Logger.error('加载关卡失败:', err);\r\n                    reject(new Error('加载关卡失败: ' + err.message));\r\n                    return;\r\n                }\r\n\r\n                try {\r\n                    const levelData = jsonAsset.json as LevelData;\r\n\r\n                    if (this.validateLevelData(levelData)) {\r\n                        this.currentLevel = levelId;\r\n                        this.currentLevelData = levelData;\r\n                        resolve(levelData);\r\n                    } else {\r\n                        Logger.error('关卡数据验证失败:', levelId);\r\n                        reject(new Error('关卡数据验证失败'));\r\n                    }\r\n                } catch (e) {\r\n                    Logger.error('关卡数据解析失败:', e);\r\n                    reject(new Error('关卡数据解析失败'));\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 验证关卡数据\r\n     */\r\n    private validateLevelData(levelData: any): boolean {\r\n        if (!levelData.levelId || !levelData.matrix || !levelData.worms || !levelData.escapePoints) {\r\n            return false;\r\n        }\r\n\r\n        if (!levelData.matrix.width || !levelData.matrix.height) {\r\n            return false;\r\n        }\r\n\r\n        if (!Array.isArray(levelData.worms) || levelData.worms.length === 0) {\r\n            return false;\r\n        }\r\n\r\n        if (!Array.isArray(levelData.escapePoints) || levelData.escapePoints.length === 0) {\r\n            return false;\r\n        }\r\n\r\n        // 验证蠕虫数据\r\n        for (const worm of levelData.worms) {\r\n            if (!worm.id || !worm.segments || !worm.direction || !worm.color) {\r\n                return false;\r\n            }\r\n            if (!Array.isArray(worm.segments) || worm.segments.length < 2) {\r\n                return false;\r\n            }\r\n            // 验证坐标范围\r\n            for (const segment of worm.segments) {\r\n                if (segment.x < 0 || segment.x >= levelData.matrix.width ||\r\n                    segment.y < 0 || segment.y >= levelData.matrix.height) {\r\n                    return false;\r\n                }\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 获取当前关卡数据\r\n     */\r\n    public getCurrentLevelData(): LevelData | null {\r\n        return this.currentLevelData;\r\n    }\r\n\r\n    /**\r\n     * 获取当前关卡ID\r\n     */\r\n    public getCurrentLevelId(): number | null {\r\n        return this.currentLevel;\r\n    }\r\n\r\n    /**\r\n     * 获取关卡总数\r\n     */\r\n    public getTotalLevels(): number {\r\n        return 3; // 默认3关\r\n    }\r\n}\r\n\r\n"]}