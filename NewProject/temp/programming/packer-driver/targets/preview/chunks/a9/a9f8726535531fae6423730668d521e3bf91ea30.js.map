{"version":3,"sources":["file:///G:/escapeworm/NewProject/assets/scripts/ui/GameSceneController.ts"],"names":["_decorator","Component","Node","Label","Color","director","Graphics","Vec3","tween","GameController","StorageManager","ResultController","Logger","ccclass","property","GameSceneController","gameController","storageManager","currentLevelId","onLoad","addComponent","init","getCurrentLevel","resultPanel","active","setupButtons","initGameController","gameArea","error","controllerNode","parent","node","levelLabel","heartNodes","gameSceneController","initLevel","updateLevelLabel","showError","settingsButton","on","EventType","TOUCH_END","onSettingsClick","menuButton","onMenuClick","restartButton","onRestartClick","nextButton","onNextClick","string","log","loadScene","restartLevel","hideResult","nextLevel","showResult","isVictory","levelId","resultController","getComponent","warn","setScale","to","scale","easing","start","call","message","updateHearts","failCount","i","length","graphics","clear","fillColor","circle","fill"],"mappings":"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","sourcesContent":["/**\r\n * 游戏场景控制器\r\n * 用于管理 GameScene 中的 UI 和游戏逻辑初始化\r\n */\r\nimport { _decorator, Component, Node, Label, Sprite, Color, director, Button, \r\n    Graphics, UITransform, Vec3, tween } from 'cc';\r\nimport { GameController } from '../GameController';\r\nimport { StorageManager } from '../managers/StorageManager';\r\nimport { ResultController } from './ResultController';\r\nimport { Logger } from '../utils/Logger';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameSceneController')\r\nexport class GameSceneController extends Component {\r\n    @property(Node)\r\n    public gameArea: Node | null = null;\r\n\r\n    @property(Label)\r\n    public levelLabel: Label | null = null;\r\n\r\n    @property([Node])\r\n    public heartNodes: Node[] = [];\r\n\r\n    @property(Node)\r\n    public settingsButton: Node | null = null;\r\n\r\n    @property(Node)\r\n    public menuButton: Node | null = null;\r\n\r\n    @property(Node)\r\n    public restartButton: Node | null = null;\r\n\r\n    @property(Node)\r\n    public resultPanel: Node | null = null;\r\n\r\n    @property(Label)\r\n    public resultLabel: Label | null = null;\r\n\r\n    @property(Node)\r\n    public nextButton: Node | null = null;\r\n\r\n    private gameController: GameController | null = null;\r\n    private storageManager: StorageManager | null = null;\r\n    private currentLevelId: number = 1;\r\n\r\n    protected onLoad() {\r\n        // 初始化存储管理器获取当前关卡\r\n        this.storageManager = this.addComponent(StorageManager);\r\n        this.storageManager.init();\r\n        this.currentLevelId = this.storageManager.getCurrentLevel();\r\n\r\n        // 隐藏结果面板\r\n        if (this.resultPanel) {\r\n            this.resultPanel.active = false;\r\n        }\r\n\r\n        // 设置按钮事件\r\n        this.setupButtons();\r\n\r\n        // 初始化游戏控制器\r\n        this.initGameController();\r\n    }\r\n\r\n    /**\r\n     * 初始化游戏控制器\r\n     */\r\n    private async initGameController() {\r\n        if (!this.gameArea) {\r\n            Logger.error('游戏区域节点未设置');\r\n            return;\r\n        }\r\n\r\n        // 创建游戏控制器节点\r\n        const controllerNode = new Node('GameController');\r\n        controllerNode.parent = this.node;\r\n        this.gameController = controllerNode.addComponent(GameController);\r\n\r\n        // 设置游戏控制器的属性\r\n        this.gameController.gameArea = this.gameArea;\r\n        this.gameController.levelLabel = this.levelLabel;\r\n        this.gameController.heartNodes = this.heartNodes;\r\n        // 设置 GameSceneController 的引用，以便 GameController 可以调用 showResult\r\n        this.gameController.gameSceneController = this.node;\r\n\r\n        // 初始化关卡\r\n        try {\r\n            await this.gameController.initLevel(this.currentLevelId);\r\n            this.updateLevelLabel();\r\n        } catch (error) {\r\n            Logger.error('初始化关卡失败:', error);\r\n            this.showError('加载关卡失败');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 设置按钮事件\r\n     */\r\n    private setupButtons() {\r\n        if (this.settingsButton) {\r\n            this.settingsButton.on(Node.EventType.TOUCH_END, this.onSettingsClick, this);\r\n        }\r\n        if (this.menuButton) {\r\n            this.menuButton.on(Node.EventType.TOUCH_END, this.onMenuClick, this);\r\n        }\r\n        if (this.restartButton) {\r\n            this.restartButton.on(Node.EventType.TOUCH_END, this.onRestartClick, this);\r\n        }\r\n        if (this.nextButton) {\r\n            this.nextButton.on(Node.EventType.TOUCH_END, this.onNextClick, this);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新关卡标签\r\n     */\r\n    private updateLevelLabel() {\r\n        if (this.levelLabel) {\r\n            this.levelLabel.string = `关卡 ${this.currentLevelId}`;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 设置按钮点击\r\n     */\r\n    private onSettingsClick() {\r\n        Logger.log('打开设置');\r\n        // TODO: 实现设置面板\r\n    }\r\n\r\n    /**\r\n     * 返回菜单按钮点击\r\n     */\r\n    private onMenuClick() {\r\n        director.loadScene('LaunchScene');\r\n    }\r\n\r\n    /**\r\n     * 重新开始按钮点击\r\n     */\r\n    private onRestartClick() {\r\n        this.gameController?.restartLevel();\r\n    }\r\n\r\n    /**\r\n     * 重新开始关卡（供 ResultController 调用）\r\n     */\r\n    public restartLevel() {\r\n        this.hideResult();\r\n        this.gameController?.restartLevel();\r\n    }\r\n\r\n    /**\r\n     * 下一关按钮点击\r\n     */\r\n    private onNextClick() {\r\n        this.gameController?.nextLevel();\r\n    }\r\n\r\n    /**\r\n     * 显示结果弹窗\r\n     */\r\n    public showResult(isVictory: boolean, levelId: number) {\r\n        if (!this.resultPanel) {\r\n            Logger.error('结果面板未设置');\r\n            return;\r\n        }\r\n\r\n        // 获取 ResultController 组件\r\n        let resultController = this.resultPanel.getComponent(ResultController);\r\n        if (!resultController) {\r\n            Logger.warn('结果面板上没有 ResultController 组件，尝试添加');\r\n            resultController = this.resultPanel.addComponent(ResultController);\r\n        }\r\n\r\n        // 初始化结果控制器\r\n        resultController.init(isVictory, levelId);\r\n\r\n        // 显示弹窗（带动画效果）\r\n        this.resultPanel.active = true;\r\n        \r\n        // 设置初始缩放为0，然后动画到1\r\n        this.resultPanel.setScale(0, 0, 1);\r\n        tween(this.resultPanel)\r\n            .to(0.3, { scale: new Vec3(1, 1, 1) }, { easing: 'backOut' })\r\n            .start();\r\n    }\r\n\r\n    /**\r\n     * 隐藏结果弹窗\r\n     */\r\n    public hideResult() {\r\n        if (!this.resultPanel) {\r\n            return;\r\n        }\r\n\r\n        // 动画隐藏\r\n        tween(this.resultPanel)\r\n            .to(0.2, { scale: new Vec3(0, 0, 1) }, { easing: 'backIn' })\r\n            .call(() => {\r\n                this.resultPanel!.active = false;\r\n            })\r\n            .start();\r\n    }\r\n\r\n    /**\r\n     * 显示错误信息\r\n     */\r\n    private showError(message: string) {\r\n        Logger.error(message);\r\n        // TODO: 显示错误提示 UI\r\n    }\r\n\r\n    /**\r\n     * 更新红心显示\r\n     */\r\n    public updateHearts(failCount: number) {\r\n        for (let i = 0; i < this.heartNodes.length; i++) {\r\n            if (this.heartNodes[i]) {\r\n                const graphics = this.heartNodes[i].getComponent(Graphics);\r\n                if (graphics) {\r\n                    graphics.clear();\r\n                    graphics.fillColor = i < failCount ? new Color(244, 67, 54, 255) : new Color(200, 200, 200, 255);\r\n                    graphics.circle(0, 0, 20);\r\n                    graphics.fill();\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n"]}