{"version":3,"sources":["file:///G:/escapeworm/NewProject/assets/scripts/entities/Worm.ts"],"names":["_decorator","Component","Vec2","Logger","ccclass","property","Worm","segments","originalSegments","previousSegments","isEscaped","isHighlighted","isEscaping","isAnimating","visibleSegmentCount","animationProgress","animationDuration","animationStartTime","segmentNodes","init","config","id","color","map","s","x","y","direction","indexOf","length","first","second","dx","dy","bodyDirection","oppositeDirection","getHeadPosition","getBodySegments","slice","getAllSegments","getInterpolatedSegments","progress","interpolated","i","prevSeg","currSeg","push","startMoveAnimation","newHeadPosition","duration","Promise","resolve","reject","log","newSegments","Date","now","setTimeout","completeAnimation","error","updateAnimation","currentTime","elapsed","Math","min","moveTo","reset","setVisibleSegmentCount","count","max","getVisibleSegments","setHighlighted","highlighted","markEscaped","hasEscaped","getLength","getConfig"],"mappings":"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","sourcesContent":["/**\r\n * 蠕虫实体类\r\n */\r\nimport { _decorator, Component, Node, Vec2, Vec3, Sprite, SpriteFrame, Color, tween, UITransform } from 'cc';\r\nimport { Logger } from '../utils/Logger';\r\nconst { ccclass, property } = _decorator;\r\n\r\nexport interface WormConfig {\r\n    id: number;\r\n    segments: { x: number; y: number }[];\r\n    direction: string;\r\n    color: string;\r\n}\r\n\r\n@ccclass('Worm')\r\nexport class Worm extends Component {\r\n    @property\r\n    public id: number = 0;\r\n\r\n    @property\r\n    public color: string = '#FF5733';\r\n\r\n    @property\r\n    public direction: string = 'right';\r\n\r\n    // 身体段坐标数组\r\n    public segments: Vec2[] = [];\r\n    public originalSegments: Vec2[] = [];\r\n    public previousSegments: Vec2[] = [];\r\n\r\n    // 状态\r\n    public isEscaped: boolean = false;\r\n    public isHighlighted: boolean = false;\r\n    public isEscaping: boolean = false;\r\n    public isAnimating: boolean = false;\r\n\r\n    // 显示相关\r\n    public visibleSegmentCount: number = 0;\r\n\r\n    // 动画相关\r\n    public animationProgress: number = 1.0;\r\n    public animationDuration: number = 10;\r\n    public animationStartTime: number = 0;\r\n\r\n    // 节点引用\r\n    private segmentNodes: Node[] = [];\r\n\r\n    /**\r\n     * 初始化蠕虫\r\n     */\r\n    public init(config: WormConfig) {\r\n        this.id = config.id;\r\n        this.color = config.color;\r\n\r\n        // 深拷贝原始位置\r\n        this.originalSegments = config.segments.map(s => new Vec2(s.x, s.y));\r\n        this.segments = config.segments.map(s => new Vec2(s.x, s.y));\r\n        this.previousSegments = config.segments.map(s => new Vec2(s.x, s.y));\r\n\r\n        // 计算方向\r\n        if (config.direction && ['up', 'down', 'left', 'right'].indexOf(config.direction) !== -1) {\r\n            this.direction = config.direction;\r\n        } else if (this.segments.length >= 2) {\r\n            const first = this.segments[0];\r\n            const second = this.segments[1];\r\n            const dx = second.x - first.x;\r\n            const dy = second.y - first.y;\r\n\r\n            let bodyDirection: string | null = null;\r\n            if (dx > 0) bodyDirection = 'right';\r\n            else if (dx < 0) bodyDirection = 'left';\r\n            else if (dy > 0) bodyDirection = 'down';\r\n            else if (dy < 0) bodyDirection = 'up';\r\n\r\n            const oppositeDirection: { [key: string]: string } = {\r\n                'right': 'left',\r\n                'left': 'right',\r\n                'up': 'down',\r\n                'down': 'up'\r\n            };\r\n\r\n            this.direction = bodyDirection ? oppositeDirection[bodyDirection] : 'right';\r\n        }\r\n\r\n        this.visibleSegmentCount = this.segments.length;\r\n    }\r\n\r\n    /**\r\n     * 获取头部位置\r\n     */\r\n    public getHeadPosition(): Vec2 {\r\n        return this.segments[0];\r\n    }\r\n\r\n    /**\r\n     * 获取身体段位置（不包括头部）\r\n     */\r\n    public getBodySegments(): Vec2[] {\r\n        return this.segments.slice(1);\r\n    }\r\n\r\n    /**\r\n     * 获取所有段位置\r\n     */\r\n    public getAllSegments(): Vec2[] {\r\n        return this.segments;\r\n    }\r\n\r\n    /**\r\n     * 获取插值后的段位置（用于平滑渲染）\r\n     */\r\n    public getInterpolatedSegments(progress: number | null = null): Vec2[] {\r\n        if (progress === null) {\r\n            progress = this.animationProgress;\r\n        }\r\n\r\n        if (progress >= 1.0 || !this.isAnimating) {\r\n            return this.segments;\r\n        }\r\n\r\n        const interpolated: Vec2[] = [];\r\n        for (let i = 0; i < this.segments.length; i++) {\r\n            const prevSeg = this.previousSegments[i] || this.segments[i];\r\n            const currSeg = this.segments[i];\r\n\r\n            interpolated.push(new Vec2(\r\n                prevSeg.x + (currSeg.x - prevSeg.x) * progress,\r\n                prevSeg.y + (currSeg.y - prevSeg.y) * progress\r\n            ));\r\n        }\r\n\r\n        return interpolated;\r\n    }\r\n\r\n    /**\r\n     * 开始移动动画\r\n     */\r\n    public startMoveAnimation(newHeadPosition: Vec2, duration: number = 40): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            try {\r\n                if (this.isEscaped) {\r\n                    Logger.log(`蠕虫 ${this.id} 已逃脱，跳过动画`);\r\n                    resolve();\r\n                    return;\r\n                }\r\n\r\n                Logger.log(`蠕虫 ${this.id} 开始移动动画: 从 (${this.segments[0]?.x}, ${this.segments[0]?.y}) 到 (${newHeadPosition.x}, ${newHeadPosition.y}), 持续时间=${duration}ms`);\r\n\r\n                // 保存当前位置作为动画起始位置\r\n                this.previousSegments = this.segments.map(s => new Vec2(s.x, s.y));\r\n\r\n                // 新头部在开头\r\n                const newSegments: Vec2[] = [newHeadPosition];\r\n\r\n                // 身体段跟随\r\n                for (let i = 0; i < this.segments.length - 1; i++) {\r\n                    newSegments.push(new Vec2(this.segments[i].x, this.segments[i].y));\r\n                }\r\n\r\n                this.segments = newSegments;\r\n\r\n                // 开始动画\r\n                this.animationProgress = 0;\r\n                this.isAnimating = true;\r\n                this.animationDuration = duration;\r\n                this.animationStartTime = Date.now();\r\n\r\n                // 使用 setTimeout 模拟动画完成\r\n                setTimeout(() => {\r\n                    try {\r\n                       // Logger.log(`蠕虫 ${this.id} 动画完成回调执行`);\r\n                        this.completeAnimation();\r\n                        //Logger.log(`蠕虫 ${this.id} 动画完成，resolve`);\r\n                        resolve();\r\n                    } catch (error) {\r\n                        Logger.error(`蠕虫 ${this.id} 动画完成回调中发生错误:`, error);\r\n                        reject(error);\r\n                    }\r\n                }, duration);\r\n            } catch (error) {\r\n                Logger.error(`蠕虫 ${this.id} startMoveAnimation 中发生错误:`, error);\r\n                reject(error);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 更新动画进度\r\n     */\r\n    public updateAnimation(currentTime: number): boolean {\r\n        if (!this.isAnimating) {\r\n            return true;\r\n        }\r\n\r\n        const elapsed = currentTime - this.animationStartTime;\r\n        this.animationProgress = Math.min(elapsed / this.animationDuration, 1.0);\r\n\r\n        if (this.animationProgress >= 1.0) {\r\n            this.isAnimating = false;\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * 立即完成动画\r\n     */\r\n    public completeAnimation() {\r\n        this.animationProgress = 1.0;\r\n        this.isAnimating = false;\r\n        this.previousSegments = this.segments.map(s => new Vec2(s.x, s.y));\r\n    }\r\n\r\n    /**\r\n     * 移动蠕虫到新位置（立即移动，不使用动画）\r\n     */\r\n    public moveTo(newHeadPosition: Vec2) {\r\n        if (this.isEscaped) {\r\n            return;\r\n        }\r\n\r\n        const newSegments: Vec2[] = [newHeadPosition];\r\n        for (let i = 0; i < this.segments.length - 1; i++) {\r\n            newSegments.push(new Vec2(this.segments[i].x, this.segments[i].y));\r\n        }\r\n\r\n        this.segments = newSegments;\r\n        this.previousSegments = this.segments.map(s => new Vec2(s.x, s.y));\r\n        this.isAnimating = false;\r\n        this.animationProgress = 1.0;\r\n    }\r\n\r\n    /**\r\n     * 复位到原始位置\r\n     */\r\n    public reset() {\r\n        //Logger.log(`蠕虫 ${this.id} reset: 原始位置数量=${this.originalSegments.length}`);\r\n        \r\n        // 验证原始位置数据\r\n        if (this.originalSegments.length === 0) {\r\n            Logger.error(`错误：蠕虫 ${this.id} 的 originalSegments 为空！无法重置！`);\r\n            return;\r\n        }\r\n        \r\n        this.segments = this.originalSegments.map(s => new Vec2(s.x, s.y));\r\n        this.previousSegments = this.originalSegments.map(s => new Vec2(s.x, s.y));\r\n        this.isEscaped = false;\r\n        this.isHighlighted = false;\r\n        this.isAnimating = false;\r\n        this.isEscaping = false;\r\n        this.animationProgress = 1.0;\r\n        this.visibleSegmentCount = this.segments.length;\r\n        \r\n        // 验证重置后的数据\r\n        if (this.segments.length === 0) {\r\n            Logger.error(`错误：蠕虫 ${this.id} reset 后 segments 为空！`);\r\n        }\r\n        if (this.visibleSegmentCount === 0) {\r\n            Logger.error(`错误：蠕虫 ${this.id} reset 后 visibleSegmentCount=0！`);\r\n        }\r\n        \r\n       // Logger.log(`蠕虫 ${this.id} reset完成: segments=${this.segments.length}, visibleCount=${this.visibleSegmentCount}, 头部=(${this.segments[0]?.x}, ${this.segments[0]?.y})`);\r\n    }\r\n\r\n    /**\r\n     * 设置可见段数量\r\n     */\r\n    public setVisibleSegmentCount(count: number) {\r\n        this.visibleSegmentCount = Math.max(0, Math.min(count, this.segments.length));\r\n    }\r\n\r\n    /**\r\n     * 获取可见的段\r\n     */\r\n    public getVisibleSegments(): Vec2[] {\r\n        if (this.visibleSegmentCount >= this.segments.length) {\r\n            return this.segments;\r\n        }\r\n        return this.segments.slice(-this.visibleSegmentCount);\r\n    }\r\n\r\n    /**\r\n     * 设置高亮状态\r\n     */\r\n    public setHighlighted(highlighted: boolean) {\r\n        this.isHighlighted = highlighted;\r\n    }\r\n\r\n    /**\r\n     * 标记为已逃脱\r\n     */\r\n    public markEscaped() {\r\n        this.isEscaped = true;\r\n    }\r\n\r\n    /**\r\n     * 检查蠕虫是否已逃脱\r\n     */\r\n    public hasEscaped(): boolean {\r\n        return this.isEscaped;\r\n    }\r\n\r\n    /**\r\n     * 获取蠕虫长度\r\n     */\r\n    public getLength(): number {\r\n        return this.segments.length;\r\n    }\r\n\r\n    /**\r\n     * 获取蠕虫配置\r\n     */\r\n    public getConfig(): WormConfig {\r\n        return {\r\n            id: this.id,\r\n            segments: this.segments.map(s => ({ x: s.x, y: s.y })),\r\n            direction: this.direction,\r\n            color: this.color\r\n        };\r\n    }\r\n}\r\n\r\n"]}